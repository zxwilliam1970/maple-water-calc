<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ¥“ä¹‹è°·è£œæ°´æ•ˆç‡åŠ©æ‰‹ï¼ˆArtaleç‰ˆï¼‰ï½œæ³•å¸«ï¼ˆç«æ¯’ï¼‰</title>
<style>
  :root{
    --bg:#0b1020;--card:#101935;--muted:#8ea0c7;--fg:#e9efff;--acc:#7bdcff;--grid:#1c2647;
    --ok:#2fd67f;--warn:#f7bf45;--bad:#ff6b6b
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
  a{color:var(--acc);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
  .brand h1{font-size:20px;margin:0}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .grid{grid-template-columns: 1fr 1fr } }
  .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:14px}
  .card h2{margin:2px 0 10px;font-size:16px}
  .row{display:grid;grid-template-columns: 1fr 1fr; gap:8px}
  .row3{display:grid;grid-template-columns: repeat(3,1fr); gap:8px}
  .row4{display:grid;grid-template-columns: repeat(4,1fr); gap:8px}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--grid);background:#0e1730;color:var(--fg);font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--grid);border-radius:999px;font-size:12px;color:var(--muted);margin-right:6px;margin-bottom:6px}
  .result{display:grid;grid-template-columns:1fr;gap:8px}
  .callout{border-left:4px solid var(--acc);background:#0f1a39;padding:10px 12px;border-radius:8px}
  .ok{border-left-color:var(--ok)}
  .warn{border-left-color:var(--warn)}
  .bad{border-left-color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;font-size:13px;padding:8px 10px;background:#0e1730;border:1px solid var(--grid)}
  th{color:#b9c8ef;background:#0c1630}
  tr>td:first-child, tr>th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr>td:last-child, tr>th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#14224a;border:1px solid var(--grid);font-size:12px;margin-left:6px}
  .btn{background:linear-gradient(180deg,#2a74ff,#2156c9);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .footer{margin:16px 0 40px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 13c4 0 7-3 7-7 0 0 0 0 0 0 0 4 3 7 7 7 0 0 0 0 0 0-4 0-7 3-7 7 0 0 0 0 0 0 0-4-3-7-7-7Z" fill="#7BDcff"/></svg>
      <div>
        <h1>æ¥“ä¹‹è°·è£œæ°´æ•ˆç‡åŠ©æ‰‹ï¼ˆArtaleç‰ˆï¼‰</h1>
        <div class="subtitle">æ³•å¸«ï¼ˆç«æ¯’ï¼‰ï½œ%è‡ªå‹•è£œå»ºè­°ã€678ç†è«–ã€æœ€çœè£œå“æ­é…</div>
      </div>
    </div>

    <!-- åŸºæœ¬è¼¸å…¥ -->
    <div class="grid">
      <div class="card">
        <h2>è§’è‰²èˆ‡ç’°å¢ƒ</h2>
        <div class="row">
          <div>
            <label>æœ€å¤§ HP</label>
            <input id="maxHP" type="number" min="1" value="1200" />
          </div>
          <div>
            <label>æœ€å¤§ MP</label>
            <input id="maxMP" type="number" min="1" value="7000" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>è¢«æ’ / è¢«æ‰“ï¼šå–®æ¬¡å‚·å®³ï¼ˆä¼°å€¼ï¼‰</label>
            <input id="hitDmg" type="number" min="1" value="1350" />
          </div>
          <div>
            <label>è‡ªå‹•è£œç­–ç•¥</label>
            <select id="autoMode">
              <option value="678" selected>678 ç†è«–ï¼ˆå»ºè­°ï¼‰</option>
              <option value="700">MPç›®æ¨™ 700ï¼ˆæ‰£åˆ°å°±è£œï¼‰</option>
              <option value="800">MPç›®æ¨™ 800ï¼ˆæ‰£åˆ°å°±è£œï¼‰</option>
              <option value="manual">æ‰‹å‹•è¼¸å…¥ % é–€æª»</option>
            </select>
          </div>
        </div>
        <div class="row" id="manualRow" style="margin-top:8px; display:none">
          <div>
            <label>è‡ªå‹•è£œ HPï¼… é–€æª»</label>
            <input id="hpPctManual" type="number" min="1" max="99" value="80" />
          </div>
          <div>
            <label>è‡ªå‹•è£œ MPï¼… é–€æª»</label>
            <input id="mpPctManual" type="number" min="1" max="99" value="10" />
          </div>
        </div>
        <div class="help" style="margin-top:8px">
          è¨»ï¼š678 æ¨¡å¼æœƒè‡ªå‹•ç”¨ âŒŠ678 / æœ€å¤§MPâŒ‹% ä½œç‚º MP è‡ªå‹•è£œé–€æª»ï¼Œä¸¦å»ºè­° HPï¼… ä¾ä½ è¢«æ‰“çš„å¯¦æä¼°å€¼é…ç½®ã€‚
        </div>
      </div>

      <!-- æŠ€èƒ½ -->
      <div class="card">
        <h2>æŠ€èƒ½ç­‰ç´šï¼ˆå¯äº’å‹•ï¼‰</h2>
        <div class="row4">
          <div>
            <label>é­”å¿ƒé˜²ç¦¦ Lv.</label>
            <select id="mgLv"></select>
          </div>
          <div>
            <label>é­”åŠ›ä¹‹ç›¾ Lv.</label>
            <select id="maLv"></select>
          </div>
          <div>
            <label>ç¬é–“ç§»å‹• Lv.</label>
            <select id="teleLv"></select>
          </div>
          <div>
            <label>é­”åŠ›æ¿€ç™¼ Lv.</label>
            <select id="ampLv"></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>æ¯’éœ§ Lv.</label>
            <select id="poisonMistLv"></select>
          </div>
          <div>
            <label>è‡´å‘½æ¯’éœ§ Lv.</label>
            <select id="poisonFogLv"></select>
          </div>
        </div>
        <div class="help" style="margin-top:8px">
          æœ¬å·¥å…·åªè¨ˆå…¥æŠ€èƒ½ã€Œè€—é­”/è€—è¡€ã€èˆ‡ã€Œé­”å¿ƒæ›¿ä»£ç‡ã€å°è£œæ°´çš„å½±éŸ¿ï¼›æŠ€èƒ½å¯¦éš›å‚·å®³ã€å‘½ä¸­ã€ç¯„åœä¸ç´å…¥è¨ˆç®—ã€‚
        </div>
      </div>
    </div>

    <!-- åƒ¹æ ¼ä¾†æº -->
    <div class="card" style="margin-top:12px">
      <h2>è£œå“åƒ¹æ ¼ä¾†æº</h2>
      <div class="row">
        <div>
          <label>åƒ¹æ ¼æ¨¡å¼</label>
          <select id="priceMode">
            <option value="min" selected>ç”¨æœ€ä½åƒ¹ï¼ˆç¶“æ¿Ÿå¯¦æƒ ï¼‰</option>
            <option value="loc">æŒ‡å®šåœ°é»åƒ¹æ ¼</option>
          </select>
        </div>
        <div>
          <label>æŒ‡å®šåœ°é»ï¼ˆé¸æ­¤é …éœ€æ­é…ã€ŒæŒ‡å®šåœ°é»åƒ¹æ ¼ã€ï¼‰</label>
          <select id="priceLoc" disabled></select>
        </div>
      </div>
      <div class="help" style="margin-top:8px">
        å¯åˆ‡æ›ã€Œç”¨æœ€ä½åƒ¹ã€æˆ–ã€ŒæŒ‡å®šåœ°é»ã€ã€‚è‹¥é¸æŒ‡å®šåœ°é»ï¼Œä»¥ä¸‹æ¨è–¦è¨ˆç®—èˆ‡è¡¨æ ¼éƒ½æœƒä»¥è©²åœ°é»åƒ¹æ ¼ç‚ºæº–ã€‚
      </div>
    </div>

    <!-- è¨ˆç®—çµæœ -->
    <div class="grid" style="margin-top:12px">
      <div class="card">
        <h2>å»ºè­°è‡ªå‹•è£œé–€æª» & æ¯åˆ€å¯¦éš›æ¶ˆè€—</h2>
        <div class="result" id="summary">
          <!-- JS å‹•æ…‹å¡«å…¥ -->
        </div>
        <div style="margin-top:10px">
          <button class="btn" id="recalc">é‡æ–°è¨ˆç®—</button>
        </div>
      </div>

      <div class="card">
        <h2>æ¨è–¦è£œå“çµ„åˆï¼ˆæœ€çœï¼‰</h2>
        <div id="reco">
          <!-- JS å‹•æ…‹å¡«å…¥ -->
        </div>
      </div>
    </div>

    <!-- è£œå“è¡¨ -->
    <div class="card" style="margin-top:12px">
      <h2>è£œå“è³‡æ–™ï¼ˆArtale ç‰ˆï¼‰<span class="badge" id="badgePriceMode">æœ€ä½åƒ¹</span></h2>
      <div class="help">CP å€¼ï¼è£œé‡ / åƒ¹æ ¼ï¼ˆåŒå“å¤šåœ°é»æœƒé¡¯ç¤ºç•¶å‰åƒ¹æ ¼æ¨¡å¼ä¸‹çš„è£œé‡ï¼åƒ¹æ ¼ï¼è½‰æ›ç‡ï¼‰</div>

      <h3 style="margin:14px 0 6px">HP è—¥æ°´</h3>
      <div id="hpTable"></div>

      <h3 style="margin:14px 0 6px">MP è—¥æ°´</h3>
      <div id="mpTable"></div>

      <h3 style="margin:14px 0 6px">ç¶œåˆï¼ˆåŒæ™‚è£œ HP&MPï¼‰</h3>
      <div id="mixTable"></div>
    </div>

    <div class="footer">
      ç‰ˆæœ¬ï¼šArtale-æ•´åˆæœ€çµ‚ç‰ˆã€‚è³‡æ–™æºï¼šä½ æä¾›çš„è¡¨ï¼ˆå«å¤šåœ°é»åƒ¹ï¼‰ã€‚è¨ˆç®—åƒ…ä¾›åƒè€ƒï¼Œå¯¦æˆ°è«‹ä»¥è‡ªèº«æ©Ÿé«”èˆ‡åœ°åœ–ç‹€æ³å¾®èª¿ã€‚
    </div>
  </div>

<script>
/* ========= è³‡æ–™å€ï¼šæŠ€èƒ½è¡¨ ========= */
// é­”å¿ƒé˜²ç¦¦ï¼ˆMagic Guardï¼‰æ›¿ä»£ç‡ & ç¶­è­·è€—é­”ï¼ˆå¥—ç”¨ä½ æä¾›çš„è¡¨ï¼‰
const MAGIC_GUARD = Array.from({length:20}, (_,i)=>{
  const lv=i+1;
  const ratio=[4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80][i];
  const mpCost = lv<=10?6:12;
  const durSec = [30,60,90,120,150,180,210,240,270,300,330,360,390,420,450,480,510,540,570,600][i];
  return {lv, ratio, mpCost, durSec};
});

// é­”åŠ›ä¹‹ç›¾ï¼ˆMagic Armorï¼‰
const MAGIC_ARMOR = Array.from({length:20}, (_,i)=>{
  const lv=i+1;
  const mpCost = lv<=10?8:16;
  const durSec = [20,40,60,80,100,120,140,160,180,200,220,240,260,280,300,320,340,360,380,400][i];
  const def = 2*lv;
  return {lv, mpCost, durSec, def};
});

// ç¬é–“ç§»å‹•ï¼ˆMPï¼‰
const TELEPORT = Array.from({length:20}, (_,i)=>{
  const lv=i+1;
  const mp = [60,57,54,51,48,45,42,39,36,33,31,29,27,25,23,21,19,17,15,13][i];
  return {lv, mp};
});

// æ¯’éœ§ï¼ˆ2è½‰ï¼‰
const POISON_MIST = Array.from({length:30}, (_,i)=>{
  const lv=i+1;
  const mp = lv<=15?10:20;
  return {lv, mp};
});

// è‡´å‘½æ¯’éœ§ï¼ˆ3è½‰ï¼‰
const POISON_FOG = Array.from({length:30}, (_,i)=>{
  const lv=i+1;
  const mp = 20+lv; // 1â†’21, 30â†’50ï¼ˆç…§è¡¨ï¼‰
  return {lv, mp};
});

// æ¥µé€Ÿè© å”±ï¼ˆæ¯æ¬¡æ–½æ”¾è€—è¡€/è€—é­”ï¼‰
const SPELL_BOOST = Array.from({length:20},(_,i)=>{
  const lv=i+1;
  const hp=[58,56,54,52,50,48,46,44,42,40,39,38,37,36,35,34,33,32,31,30][i];
  const mp=[53,51,49,47,45,43,41,39,37,35,34,33,32,31,30,29,28,27,26,25][i];
  return {lv,hp,mp};
});

// é­”åŠ›æ¿€ç™¼ï¼ˆè€—é­”å€ç‡ï¼‰
const AMP_MAGIC = Array.from({length:30},(_,i)=>{
  const lv=i+1;
  const costPct=[105,110,115,120,125,130,135,140,145,150,160,155,165,160,170,165,175,170,180,175,185,180,190,185,195,190,205,200,195,200][i];
  const dmgPct=[107,109,111,113,114,115,116,117,118,119,121,121,123,123,125,125,127,127,129,129,131,131,133,133,135,135,137,137,137,140][i];
  return {lv,costPct,dmgPct};
});

/* ========= è³‡æ–™å€ï¼šè£œå“ï¼ˆArtale ç‰ˆï¼Œå¤šåœ°é»ï¼‰ =========
   å‚™è¨»ï¼šæ¯å€‹é …ç›®ä»¥ {name, amount, prices: {åœ°é»:åƒ¹æ ¼}} è¡¨ç¤ºã€‚
   è½‰æ›ç‡= amount / ä½¿ç”¨åƒ¹æ ¼ï¼ˆæœƒä¾ç•¶å‰æ¨¡å¼å–ç”¨æœ€ä½æˆ–æŒ‡å®šåœ°é»ï¼‰
*/

const HP_POTS = [
  {name:"è˜‹æœ", amount:30, prices:{ "é˜²è¡›æœ¬éƒ¨":28, "å…¶é¤˜åœ°åœ–":30 }},
  {name:"ç´…è‰²è—¥æ°´/é›è›‹", amount:50, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":47, "å…¶é¤˜åœ°åœ–":50 }},
  {name:"çƒ¤è‚‰", amount:100, prices:{ "å…¨è—¥æ°´åº—å‡ä¸€åƒ¹":106 }},
  {name:"æ©˜è‰²è—¥æ°´", amount:150, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":152, "å…¶é¤˜åœ°åœ–":160 }},
  {name:"ç‚¸é›", amount:200, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":209, "èèŸ»æ´":220 }},
  {name:"ç™½è‰²è—¥æ°´", amount:300, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":304, "ç…‰é‡‘è¡“å£«çä»»å‹™":310, "å…¶é¤˜åœ°åœ–":320 }},
  {name:"å¤§ç†±ç‹—", amount:300, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":304, "èèŸ»æ´":320 }},
  {name:"æŠ«è–©/æ¼¢å ¡", amount:400, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":427, "èèŸ»æ´":450 }},
  {name:"ç†±ç‹—å ¡", amount:500, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":503, "èèŸ»æ´":530 }},
  {name:"çƒ¤é°»é­š", amount:1000, prices:{ "é˜²è¡›æœ¬éƒ¨":1045, "ç…‰é‡‘è¡“å£«çä»»å‹™":1060, "å¤šåœ°å€é€šç”¨åƒ¹":1100, "æ„›å¡”-ç³–æœæ©Ÿ":1144 }},
  {name:"æ£’å†°æ£’", amount:2000, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":2185, "å¤šåœ°å€é€šç”¨åƒ¹":2300 }},
  {name:"ä¹³é…ª", amount:4000, prices:{ "å†°åŸ/ç«¥è©±æ‘/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":4500, "æ„›å¡”/é˜²è¡›æœ¬éƒ¨/æ™‚é–“é€šé“":4680 }},
  {name:"é¦´é¹¿å¥¶", amount:5000, prices:{ "å†°åŸ/é˜²è¡›æœ¬éƒ¨/ç«¥è©±æ‘/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":5600, "æ„›å¡”-ç³–æœæ©Ÿ/æ™‚é–“é€šé“":5824 }},
];

const MP_POTS = [
  {name:"æŸ³æ©™", amount:50, prices:{ "é˜²è¡›æœ¬éƒ¨":95, "é­”æ£®":97, "å…¶é¤˜åœ°åœ–":100 }},
  {name:"è—è‰²è—¥æ°´", amount:100, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":190, "é­”æ£®":192, "å…¶é¤˜åœ°åœ–":200 }},
  {name:"æª¸æª¬", amount:150, prices:{ "é˜²è¡›æœ¬éƒ¨":294, "é­”æ£®":305, "å…¶é¤˜åœ°åœ–":310 }},
  {name:"æ²™æ‹‰", amount:200, prices:{ "èèŸ»æ´":420 }},
  {name:"æ´»åŠ›è—¥æ°´", amount:300, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":589, "é­”æ£®":604, "å…¶é¤˜åœ°åœ–":620 }},
  {name:"ç¤¦æ³‰æ°´", amount:800, prices:{ "é˜²è¡›æœ¬éƒ¨":1567, "ç…‰é‡‘è¡“å£«çä»»å‹™":1600, "å¤šåœ°å€é€šç”¨åƒ¹":1650, "æ„›å¡”-ç³–æœæ©Ÿ":1716 }},
  {name:"ç´…è±†åˆ¨å†°", amount:2000, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":3800, "å¤šåœ°å€é€šç”¨åƒ¹":4000 }},
  {name:"æ¸…æ™¨ä¹‹éœ²", amount:4000, prices:{ "é˜²è¡›æœ¬éƒ¨":7695, "å†°åŸ/ç«¥è©±æ‘/æ™‚é–“é€šé“/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":8100, "æ„›å¡”-ç³–æœæ©Ÿ":8424 }},
  {name:"é»ƒæ˜ä¹‹éœ²", amount:5000, prices:{ "é˜²è¡›æœ¬éƒ¨":9690, "å†°åŸ/ç«¥è©±æ‘/æ™‚é–“é€šé“/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":10200, "æ„›å¡”-ç³–æœæ©Ÿ":10608 }},
];

const MIX_POTS = [
  {name:"å·§å…‹åŠ›(1000/1000)", hp:1000, mp:1000, prices:{ "ä¸€èˆ¬":3000, "ç©å…·åŸ":2850 }},
  {name:"è›‹ç³•(100/100)", hp:100, mp:100, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":304, "èèŸ»æ´":320 }},
  {name:"è¥¿ç“œ(1000/1000)", hp:1000, mp:1000, prices:{ "é˜²è¡›æœ¬éƒ¨":3034, "ç…‰é‡‘è¡“å£«çä»»å‹™":3120, "å¤šåœ°å€é€šç”¨åƒ¹":3200 }},
];

/* ========= UIï¼šé¸å–®åˆå§‹åŒ– ========= */
function fillSelect(id, max){
  const el=document.getElementById(id);
  el.innerHTML="";
  for(let i=1;i<=max;i++){
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=i;
    el.appendChild(opt);
  }
}
fillSelect("mgLv",20);
fillSelect("maLv",20);
fillSelect("teleLv",20);
fillSelect("ampLv",30);
fillSelect("poisonMistLv",30);
fillSelect("poisonFogLv",30);

const priceLocSel=document.getElementById("priceLoc");
const ALL_LOCS = Array.from(new Set([
  ...HP_POTS.flatMap(p=>Object.keys(p.prices)),
  ...MP_POTS.flatMap(p=>Object.keys(p.prices)),
  ...MIX_POTS.flatMap(p=>Object.keys(p.prices))
]));
ALL_LOCS.forEach(loc=>{
  const opt=document.createElement("option");
  opt.value=loc; opt.textContent=loc;
  priceLocSel.appendChild(opt);
});
priceLocSel.value=ALL_LOCS[0];

/* ========= åƒ¹æ ¼æ¨¡å¼åˆ‡æ› ========= */
const priceModeSel=document.getElementById("priceMode");
priceModeSel.addEventListener("change", ()=>{
  const isLoc=priceModeSel.value==="loc";
  priceLocSel.disabled=!isLoc;
  document.getElementById("badgePriceMode").textContent=isLoc?`æŒ‡å®šåœ°é»ï¼š${priceLocSel.value}`:"æœ€ä½åƒ¹";
  renderTables();
  recalcAll();
});
priceLocSel.addEventListener("change", ()=>{
  document.getElementById("badgePriceMode").textContent=`æŒ‡å®šåœ°é»ï¼š${priceLocSel.value}`;
  renderTables();
  recalcAll();
});

/* ========= è‡ªå‹•è£œæ¨¡å¼ ========= */
const autoModeSel=document.getElementById("autoMode");
autoModeSel.addEventListener("change", ()=>{
  document.getElementById("manualRow").style.display = autoModeSel.value==="manual" ? "" : "none";
  recalcAll();
});

/* ========= å·¥å…·å‡½å¼ ========= */
function pickPrice(prices){
  if(priceModeSel.value==="min"){
    return Math.min(...Object.values(prices));
  }else{
    const loc=priceLocSel.value;
    return (loc in prices)? prices[loc] : Math.min(...Object.values(prices));
  }
}
function cp(amount, price){ return amount/price; }
function fmtPct(n){ return `${n}%`; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function floor(n){ return Math.floor(n); }

/* ========= è¨ˆç®—ï¼šæ¯åˆ€å¯¦æã€æ¨è–¦é–€æª» ========= */
function calcHitLoss(hit, mgLv){
  const mg = MAGIC_GUARD[mgLv-1]??{ratio:0};
  const r = mg.ratio/100; // 0~0.8
  const mpLoss = hit * r;
  const hpLoss = hit * (1-r);
  return {hpLoss, mpLoss, mgRatio:mg.ratio};
}

function suggestThresholds(maxHP,maxMP,hit, mgLv, mode, manualHPpct, manualMPpct){
  const loss = calcHitLoss(hit, mgLv);
  let mpPct, hpPct, note=[];
  if(mode==="678"){
    mpPct = floor((678/maxMP)*100);
    note.push("678ç†è«–ï¼šè‡ªå‹•è£œMP=âŒŠ678/æœ€å¤§MPâŒ‹%");
  }else if(mode==="700"){
    mpPct = floor((700/maxMP)*100);
    note.push("ç›®æ¨™700ç­–ç•¥ï¼šè‡ªå‹•è£œMPâ‰ˆ700/æœ€å¤§MP");
  }else if(mode==="800"){
    mpPct = floor((800/maxMP)*100);
    note.push("ç›®æ¨™800ç­–ç•¥ï¼šè‡ªå‹•è£œMPâ‰ˆ800/æœ€å¤§MP");
  }else{
    mpPct = clamp(floor(manualMPpct),1,99);
    note.push("æ‰‹å‹•MPé–€æª»");
  }
  // HPï¼…ï¼šè®“è¢«æ‰“ä¸€åˆ€é€šå¸¸æœƒä½æ–¼é–€æª»ä»¥è§¸ç™¼è£œè¡€ï¼ˆå¤šç•™1%å®¹éŒ¯ï¼‰
  const hpAfterHitPct = floor(((maxHP - loss.hpLoss)/maxHP)*100);
  hpPct = clamp(Math.min(99, Math.max(1, hpAfterHitPct+1)),1,99);
  if(mode==="manual"){
    hpPct = clamp(floor(manualHPpct),1,99);
    note.unshift("æ‰‹å‹•HPé–€æª»");
  }else{
    note.push("HPé–€æª»ä»¥è¢«æ‰“ä¸€åˆ€å¾Œç•¥ä½æ–¼é–€æª»ç‚ºåŸå‰‡ (+1% ç·©è¡)");
  }
  return {hpPct, mpPct, loss, note: note.join("ï¼›")};
}

/* ========= æ¨è–¦è£œå“ï¼šæœ€çœåˆèƒ½ã€Œæ¥ä½ã€æ¶ˆè€— ========= */
function bestHpPot(needHP){
  // æ‰¾ã€Œåƒ¹æ ¼æœ€ä½ä¸”è£œé‡ >= éœ€è¦é‡ã€ï¼›è‹¥æ²’æœ‰ï¼Œå–è£œé‡æœ€å¤§çš„é‚£å€‹ï¼ˆæˆæœ¬æœ€ä½ / 1000é‡ï¼‰
  let candidates=[];
  for(const p of HP_POTS){
    const price=pickPrice(p.prices);
    candidates.push({name:p.name, amount:p.amount, price, cp:cp(p.amount,price)});
  }
  // å…ˆæ‰¾èƒ½å–®ç“¶è£œåˆ° â‰¥ needHPï¼Œå–åƒ¹æ ¼æœ€ä¾¿å®œ
  const enough = candidates.filter(c=>c.amount>=needHP).sort((a,b)=>a.price-b.price || b.cp-a.cp);
  if(enough.length) return enough[0];
  // å¦å‰‡å– CP å€¼æœ€é«˜çš„ï¼ˆæ¯ 1000 é‡æœ€ä¾¿å®œï¼‰
  return candidates.sort((a,b)=> (b.cp - a.cp) || (a.price-b.price))[0];
}

function bestMpPot(needMP){
  let candidates=[];
  for(const p of MP_POTS){
    const price=pickPrice(p.prices);
    candidates.push({name:p.name, amount:p.amount, price, cp:cp(p.amount,price)});
  }
  const enough = candidates.filter(c=>c.amount>=needMP).sort((a,b)=>a.price-b.price || b.cp-a.cp);
  if(enough.length) return enough[0];
  return candidates.sort((a,b)=> (b.cp - a.cp) || (a.price-b.price))[0];
}

/* ========= é‡æ–°è¨ˆç®— ========= */
function recalcAll(){
  const maxHP = +document.getElementById("maxHP").value||1;
  const maxMP = +document.getElementById("maxMP").value||1;
  const hitDmg = +document.getElementById("hitDmg").value||0;

  const mgLv = +document.getElementById("mgLv").value||1;
  const maLv = +document.getElementById("maLv").value||1;
  const teleLv = +document.getElementById("teleLv").value||1;
  const ampLv = +document.getElementById("ampLv").value||1;
  const mistLv = +document.getElementById("poisonMistLv").value||1;
  const fogLv = +document.getElementById("poisonFogLv").value||1;

  const manualHPpct= +document.getElementById("hpPctManual").value||80;
  const manualMPpct= +document.getElementById("mpPctManual").value||10;
  const mode=autoModeSel.value;

  const {hpPct, mpPct, loss, note} = suggestThresholds(maxHP,maxMP,hitDmg,mgLv,mode, manualHPpct, manualMPpct);

  // ä¼°ç®—ä¸€æ¬¡ã€Œè¢«æ‰“ä¸€åˆ€ â†’ è§¸ç™¼è£œã€å¾Œï¼Œå¸Œæœ›è£œå›çš„é‡ï¼š
  // HP ç›®æ¨™ï¼šè£œåˆ°è¶…éé–€æª»ï¼ˆæŠ“åˆ°æ»¿æˆ–åˆ°å®‰å…¨ï¼‰ï¼Œå–éœ€è¦é‡ = max(é–€æª»%*maxHP - (maxHP - hpLoss), 0)
  const hpAfter = maxHP - loss.hpLoss;
  const hpTarget = Math.ceil(hpPct/100 * maxHP);
  const needHP = Math.max(hpTarget - hpAfter, 0);

  // MP ç›®æ¨™ï¼šä¾æ¨¡å¼ï¼ˆ678/700/800/æ‰‹å‹•ï¼‰ä¼°å›åˆ°è©²é–€æª»ä»¥ä¸Šï¼›ä¹Ÿè€ƒæ…®ç¬ç§»èˆ‡æ¯’ç³»æŠ€èƒ½é€£æ”¾çš„ç·©è¡ï¼ˆç°¡åŒ–æŠ“ 2*ç¬ç§» + 2*è‡´å‘½æ¯’éœ§ï¼‰
  const mpAfter = maxMP - loss.mpLoss;
  let mpTarget = Math.ceil(mpPct/100 * maxMP);
  // ç·©è¡ï¼š2*ç¬ç§» + 2*è‡´å‘½æ¯’éœ§
  const teleMP = TELEPORT[teleLv-1].mp;
  const fogMP = POISON_FOG[fogLv-1].mp;
  const buffer = 2*teleMP + 2*fogMP; // èˆ‡ 678 ç†å¿µä¸€è‡´ï¼šè‡³å°‘èƒ½å¤šæ”¾å¹¾ä¸‹å†è£œ
  mpTarget += buffer;
  mpTarget = Math.min(mpTarget, maxMP);
  const needMP = Math.max(mpTarget - mpAfter, 0);

  const hpPick = bestHpPot(needHP);
  const mpPick = bestMpPot(needMP);

  // æŠ€èƒ½ç¶­è­·è€—é­”é ä¼°ï¼ˆæ¯åˆ†é˜ï¼›åªåˆ—å‡ºæœƒæŒçºŒçš„ï¼‰
  const mg = MAGIC_GUARD[mgLv-1];
  const ma = MAGIC_ARMOR[maLv-1];
  const mgPerMin = mg ? mg.mpCost * (60 / (mg.durSec||60)) : 0;
  const maPerMin = ma ? ma.mpCost * (60 / (ma.durSec||60)) : 0;

  // æ–½æ”¾æŠ€èƒ½å–®æ¬¡è€—é­”ï¼ˆå—é­”åŠ›æ¿€ç™¼å½±éŸ¿ï¼‰
  const amp = AMP_MAGIC[ampLv-1]||{costPct:100};
  const ampRate = (amp.costPct||100)/100;
  const teleOnce = TELEPORT[teleLv-1].mp * ampRate;
  const mistOnce = POISON_MIST[mistLv-1].mp * ampRate;
  const fogOnce  = POISON_FOG[fogLv-1].mp * ampRate;
  const boost = SPELL_BOOST[9]; // å–Lv10ç¤ºæ„? ä¸ï¼Œé¡¯ç¤ºå°ç…§è¡¨ï¼Œé€™è£¡ä¸è‡ªå‹•çºŒï¼›è²»ç”¨åœ¨ä¸Šé¢ buffer å·²è€ƒæ…®é€£æ”¾ç·©è¡å³å¯ã€‚

  // è¼¸å‡º
  const sum = document.getElementById("summary");
  sum.innerHTML = `
    <div class="callout ok">
      <div>ğŸ›¡ï¸ é­”å¿ƒæ›¿ä»£ç‡ï¼š<b>${mg?.ratio||0}%</b>ï¼ˆLv.${mgLv}ï¼Œç¶­è­·ï¼š${mg?.mpCost||0} MP / ${mg?.durSec||0}sï¼‰</div>
      <div>ğŸ§· é­”åŠ›ä¹‹ç›¾ï¼šLv.${maLv}ï¼ˆç¶­è­·ï¼š${ma?.mpCost||0} MP / ${ma?.durSec||0}sï¼‰</div>
    </div>
    <div class="callout">
      <div>ğŸ’¥ æ¯åˆ€å¯¦æ â‰ˆ <b>HP ${Math.round(loss.hpLoss)}</b>ã€<b>MP ${Math.round(loss.mpLoss)}</b></div>
      <div class="muted">ï¼ˆä»¥è¼¸å…¥çš„å–®æ¬¡å‚·å®³ ${hitDmg} èˆ‡é­”å¿ƒæ¯”ä¾‹ ${mg?.ratio||0}% è¨ˆç®—ï¼‰</div>
    </div>
    <div class="callout">
      <div>ğŸ§® å»ºè­°è‡ªå‹•è£œé–€æª»ï¼šHP <b>${fmtPct(hpPct)}</b>ã€MP <b>${fmtPct(mpPct)}</b></div>
      <div class="muted">${note}</div>
    </div>
    <div class="callout">
      <div>ğŸ§± æŠ€èƒ½ç¶­è­·è€—é­”ï¼ˆä¼°æ¯åˆ†é˜ï¼‰ï¼šé­”å¿ƒ ${mgPerMin.toFixed(1)} MP / minã€é­”ç›¾ ${maPerMin.toFixed(1)} MP / min</div>
      <div class="muted">ç¬ç§»å–®æ¬¡ ${Math.round(teleOnce)} MPã€æ¯’éœ§å–®æ¬¡ ${Math.round(mistOnce)} MPã€è‡´å‘½æ¯’éœ§å–®æ¬¡ ${Math.round(fogOnce)} MPï¼ˆå«é­”åŠ›æ¿€ç™¼å€ç‡ï¼‰</div>
    </div>
  `;

  const reco = document.getElementById("reco");
  const hpCp1000 = (1000 * hpPick.price / hpPick.amount).toFixed(1);
  const mpCp1000 = (1000 * mpPick.price / mpPick.amount).toFixed(1);
  reco.innerHTML = `
    <div class="callout ok">
      <div>âœ… æ¨è–¦ HP è£œå“ï¼š<b>${hpPick.name}</b>ï¼ˆè£œ ${hpPick.amount}ï¼Œ$${hpPick.price}ï¼ŒCP=${(hpPick.amount/hpPick.price).toFixed(3)}ï¼‰<br/>
      ä¼°è¨ˆéœ€è¦è£œå›ï¼š<b>${Math.round(needHP)}</b> â‡’ å–®ç“¶å¯æ¥ä½ï¼š${hpPick.amount>=needHP ? "æ˜¯" : "å¦"} <span class="badge">æ¯1000é‡ â‰ˆ $${hpCp1000}</span></div>
    </div>
    <div class="callout ok">
      <div>âœ… æ¨è–¦ MP è£œå“ï¼š<b>${mpPick.name}</b>ï¼ˆè£œ ${mpPick.amount}ï¼Œ$${mpPick.price}ï¼ŒCP=${(mpPick.amount/mpPick.price).toFixed(3)}ï¼‰<br/>
      ä¼°è¨ˆéœ€è¦è£œå›ï¼š<b>${Math.round(needMP)}</b> â‡’ å–®ç“¶å¯æ¥ä½ï¼š${mpPick.amount>=needMP ? "æ˜¯" : "å¦"} <span class="badge">æ¯1000é‡ â‰ˆ $${mpCp1000}</span></div>
      <div class="muted" style="margin-top:6px">èªªæ˜ï¼šMP æœƒåŠ ä¸Šã€Œ2Ã—ç¬ç§» + 2Ã—è‡´å‘½æ¯’éœ§ã€çš„ç·©è¡é‡ï¼Œä»¥é¿å…ä¸€è£œå°±é€£çºŒè§¸ç™¼æµªè²»ï¼›è‹¥ä½ åå¥½æ¥µè‡´çœæ°´ï¼Œå¯æŠŠè‡ªå‹•è£œé–€æª»å†èª¿ä½ 1â€“2%ã€‚</div>
    </div>
  `;
}

/* ========= è¡¨æ ¼æ¸²æŸ“ ========= */
function renderTable(containerId, headers, rows){
  const el=document.getElementById(containerId);
  const table=document.createElement("table");
  const thead=document.createElement("thead");
  const trh=document.createElement("tr");
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    r.forEach((c,i)=>{
      const td=document.createElement("td");
      td.innerHTML=c;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  el.innerHTML="";
  el.appendChild(table);
}

function renderTables(){
  const isLoc = priceModeSel.value==="loc";
  const loc = priceLocSel.value;
  // HP
  const hpRows = HP_POTS.map(p=>{
    const price = pickPrice(p.prices);
    const locUsed = Object.keys(p.prices).find(k=>p.prices[k]===price) || "-";
    return [p.name, p.amount, price, (p.amount/price).toFixed(3), isLoc? loc : `æœ€ä½åƒ¹æ–¼ã€Œ${locUsed}ã€`];
  });
  renderTable("hpTable", ["è—¥æ°´å","è£œé‡(HP)","åƒ¹æ ¼","è½‰æ›ç‡","è³¼è²·åœ°"], hpRows);

  // MP
  const mpRows = MP_POTS.map(p=>{
    const price = pickPrice(p.prices);
    const locUsed = Object.keys(p.prices).find(k=>p.prices[k]===price) || "-";
    return [p.name, p.amount, price, (p.amount/price).toFixed(3), isLoc? loc : `æœ€ä½åƒ¹æ–¼ã€Œ${locUsed}ã€`];
  });
  renderTable("mpTable", ["è—¥æ°´å","è£œé‡(MP)","åƒ¹æ ¼","è½‰æ›ç‡","è³¼è²·åœ°"], mpRows);

  // MIX
  const mixRows = MIX_POTS.map(p=>{
    const price = pickPrice(p.prices);
    const locUsed = Object.keys(p.prices).find(k=>p.prices[k]===price) || "-";
    const amt = `${p.hp}&${p.mp}`;
    const ratio = ((p.hp+p.mp)/price).toFixed(3);
    return [p.name, amt, price, ratio, isLoc? loc : `æœ€ä½åƒ¹æ–¼ã€Œ${locUsed}ã€`];
  });
  renderTable("mixTable", ["è—¥æ°´å","è£œé‡(HP&MP)","åƒ¹æ ¼","æ¯”å€¼","è³¼è²·åœ°"], mixRows);
}

/* ========= äº‹ä»¶èˆ‡åˆå§‹æ¸²æŸ“ ========= */
document.getElementById("recalc").addEventListener("click", recalcAll);
document.getElementById("mgLv").addEventListener("change", recalcAll);
document.getElementById("maLv").addEventListener("change", recalcAll);
document.getElementById("teleLv").addEventListener("change", recalcAll);
document.getElementById("ampLv").addEventListener("change", recalcAll);
document.getElementById("poisonMistLv").addEventListener("change", recalcAll);
document.getElementById("poisonFogLv").addEventListener("change", recalcAll);
document.getElementById("maxHP").addEventListener("input", recalcAll);
document.getElementById("maxMP").addEventListener("input", recalcAll);
document.getElementById("hitDmg").addEventListener("input", recalcAll);
document.getElementById("hpPctManual").addEventListener("input", recalcAll);
document.getElementById("mpPctManual").addEventListener("input", recalcAll);

renderTables();
recalcAll();
</script>
</body>
</html>
