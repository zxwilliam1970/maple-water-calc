<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ¥“ä¹‹è°· è£œæ°´æ•ˆç‡åŠ©æ‰‹ï¼ˆArtale æœ€çµ‚ç‰ˆï¼‰</title>
<style>
:root{--accent:#2d8cf0;--bg:#f4f6f8;--card:#fff;--muted:#666}
body{font-family:"Microsoft JhengHei",Arial,sans-serif;background:var(--bg);margin:0;padding:18px;color:#222}
.wrap{max-width:1100px;margin:12px auto;padding:18px;background:var(--card);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
h1{color:#c0392b;margin:0 0 6px}
.small{font-size:13px;color:var(--muted)}
.tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#eef;cursor:pointer;color:var(--accent);font-weight:600}
.tab.active{background:var(--accent);color:#fff}
.panel{display:none;margin-top:14px}
.panel.active{display:block}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.col{flex:1;min-width:220px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select,button{padding:8px;border-radius:6px;border:1px solid #dfe6ee}
input[type="number"]{width:100%}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
.result{margin-top:12px;padding:12px;background:#fbfdff;border-left:4px solid var(--accent);border-radius:6px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #e6edf3;padding:6px;text-align:center}
th{background:#f7fbff}
.table-wrap{overflow:auto;max-height:420px}
.highlight{background:#fff7e6}
.muted{color:var(--muted);font-size:13px}
footer{margin-top:12px;font-size:13px;color:var(--muted);text-align:center}
@media(max-width:700px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap">
  <h1>æ¥“ä¹‹è°· è£œæ°´æ•ˆç‡åŠ©æ‰‹ï¼ˆArtale æœ€çµ‚ç‰ˆï¼‰</h1>
  <p class="small">å®Œæ•´ç‰ˆï¼šHP/MP è£œå“ï¼ˆArtale è³‡æ–™ï¼‰ã€æŠ€èƒ½ç­‰ç´šä¸‹æ‹‰ã€678 ç†è«– / æ‰‹å‹•ã€æœ€ä½æœ‰æ•ˆè£œé‡éæ¿¾ã€æ•ˆç‡èˆ‡æˆæœ¬åŒæ™‚è¨ˆç®—èˆ‡æ¨è–¦ã€‚</p>

  <div class="tabs" id="tabs">
    <div class="tab active" data-panel="home">é¦–é </div>
    <div class="tab" data-panel="hp">HP è—¥æ°´</div>
    <div class="tab" data-panel="mp">MP è—¥æ°´</div>
    <div class="tab" data-panel="eff">æ•ˆç‡è¨ˆç®—</div>
    <div class="tab" data-panel="gear">è£å‚™æ•ˆç›Š</div>
    <div class="tab" data-panel="about">èªªæ˜</div>
  </div>

  <div class="panel active" id="home">
    <h3>å¿«é€Ÿèªªæ˜</h3>
    <p class="small">ä½¿ç”¨æ­¥é©Ÿï¼šåˆ°ã€Œæ•ˆç‡è¨ˆç®—ã€è¼¸å…¥è§’è‰² HP/MPã€å¹³å‡è¢«æ‰“å‚·å®³ã€è¢«æ‰“é »ç‡ã€æŠ€èƒ½ç­‰ç´šï¼ˆé­”å¿ƒ/é­”ç›¾/ç¬ç§»/æ¯’éœ§/è‡´å‘½æ¯’éœ§ï¼‰ï¼Œé¸ 678 æˆ– æ‰‹å‹•æ¨¡å¼ï¼Œå†æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€ã€‚ç³»çµ±æœƒåŒæ™‚è¨ˆç®— HP èˆ‡ MP çš„æ¯æœŸéœ€æ±‚èˆ‡æˆæœ¬ï¼Œä¸¦åœ¨åˆæ ¼è£œå“ä¸­æ¨è–¦ã€Œæ•ˆç‡æœ€ä½³ã€èˆ‡ã€Œæˆæœ¬æœ€ä½åˆæ ¼ã€ã€‚</p>
  </div>

  <!-- HP panel -->
  <div class="panel" id="hp">
    <div class="row">
      <div class="col"><label>æœå°‹ / åç¨±</label><input id="hpSearch" placeholder="ä¾‹å¦‚ï¼šçƒ¤é°»é­š"></div>
      <div class="col"><label>ç¯©é¸è³¼è²·åœ°</label><select id="hpWhere"><option value="all">å…¨éƒ¨</option></select></div>
      <div class="col"><label>æ’åº</label><select id="hpSort"><option value="rate">è½‰æ›ç‡ (HP/åƒ¹) é«˜â†’ä½</option><option value="price">åƒ¹æ ¼ä½â†’é«˜</option><option value="hp">è£œé‡å¤§â†’å°</option></select></div>
    </div>
    <div class="table-wrap"><table id="hpTable"><thead><tr><th>è—¥æ°´</th><th>è£œé‡(HP)</th><th>åƒ¹æ ¼</th><th>è½‰æ›ç‡</th><th>è³¼è²·åœ°</th></tr></thead><tbody></tbody></table></div>
    <div id="hpNote" class="muted"></div>
  </div>

  <!-- MP panel -->
  <div class="panel" id="mp">
    <div class="row">
      <div class="col"><label>æœå°‹ / åç¨±</label><input id="mpSearch" placeholder="ä¾‹å¦‚ï¼šç¤¦æ³‰æ°´"></div>
      <div class="col"><label>ç¯©é¸è³¼è²·åœ°</label><select id="mpWhere"><option value="all">å…¨éƒ¨</option></select></div>
      <div class="col"><label>æ’åº</label><select id="mpSort"><option value="rate">è½‰æ›ç‡ (MP/åƒ¹) é«˜â†’ä½</option><option value="price">åƒ¹æ ¼ä½â†’é«˜</option><option value="mp">è£œé‡å¤§â†’å°</option></select></div>
    </div>
    <div class="table-wrap"><table id="mpTable"><thead><tr><th>è—¥æ°´</th><th>è£œé‡(MP)</th><th>åƒ¹æ ¼</th><th>è½‰æ›ç‡</th><th>è³¼è²·åœ°</th></tr></thead><tbody></tbody></table></div>
    <div id="mpNote" class="muted"></div>
  </div>

  <!-- Efficiency panel -->
  <div class="panel" id="eff">
    <h3>æ•ˆç‡ / è£œæ°´è¨ˆç®—å™¨ï¼ˆHP & MP åŒæ™‚è¨ˆç®—ï¼‰</h3>
    <div class="row">
      <div class="col"><label>æœ€å¤§ HP</label><input id="eHP" type="number" placeholder="1500"></div>
      <div class="col"><label>æœ€å¤§ MP</label><input id="eMP" type="number" placeholder="7000"></div>
      <div class="col"><label>å¹³å‡æ¯æ¬¡è¢«æ‰“å‚·å®³ï¼ˆä¼°ï¼‰</label><input id="eDmg" type="number" value="1400"></div>
    </div>

    <div class="row">
      <div class="col"><label>é­”å¿ƒé˜²ç¦¦ ç­‰ç´š (0~20)</label><select id="eHeart"></select></div>
      <div class="col"><label>é­”åŠ›ä¹‹ç›¾ ç­‰ç´š (0~20)</label><select id="eShield"></select></div>
      <div class="col"><label>æ˜¯å¦é–‹ é­”åŠ›æ¿€ç™¼ï¼ˆæ¶ˆè€—å€å¢ï¼‰</label><select id="eMB"><option value="0">å¦</option><option value="1">æ˜¯</option></select></div>
    </div>

    <div class="row">
      <div class="col"><label>æ¯åˆ†é˜è¢«æ‰“æ¬¡æ•¸ï¼ˆhits/minï¼‰</label><input id="eHits" type="number" placeholder="30"></div>
      <div class="col"><label>æ¨¡å¼</label><select id="eMode"><option value="678">678ï¼ˆé è¨­ï¼‰</option><option value="manual">æ‰‹å‹•ï¼ˆè¼¸å…¥é »ç‡ï¼‰</option></select></div>
      <div class="col"><label>è¨ˆç®—æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label><input id="eMinutes" type="number" value="60"></div>
    </div>

    <div class="row">
      <div class="col"><label>ç¬é–“ç§»å‹• ç­‰ç´š (0~20)</label><select id="eTeleLv"></select></div>
      <div class="col"><label>æ¯’éœ§ ç­‰ç´š (0~30)</label><select id="ePoisonLv"></select></div>
      <div class="col"><label>è‡´å‘½æ¯’éœ§ ç­‰ç´š (0~30)</label><select id="eDeadlyLv"></select></div>
    </div>

    <div class="row">
      <div class="col"><label>ç¬ç§»/åˆ†ï¼ˆæ‰‹å‹•ï¼‰</label><input id="eTelePerMin" type="number"></div>
      <div class="col"><label>æ¯’éœ§/åˆ†ï¼ˆæ‰‹å‹•ï¼‰</label><input id="ePoisonPerMin" type="number"></div>
      <div class="col"><label>è‡´å‘½æ¯’éœ§/åˆ†ï¼ˆæ‰‹å‹•ï¼‰</label><input id="eDeadlyPerMin" type="number"></div>
    </div>

    <div style="margin-top:10px"><button id="btnCalcEff">é–‹å§‹è¨ˆç®—</button></div>
    <div id="effResult" class="result" style="display:none"></div>
  </div>

  <!-- Gear panel -->
  <div class="panel" id="gear">
    <h3>è£å‚™ / é­”æ”»æ•ˆç›Šæ¨¡æ“¬</h3>
    <div class="row">
      <div class="col"><label>ç•¶å‰é­”æ”»</label><input id="gBaseAtk" type="number"></div>
      <div class="col"><label>æƒ³æ¸¬è©¦çš„é­”æ”»å¢åŠ  (+)</label><input id="gAddAtk" type="number"></div>
      <div class="col"><label>æ•µæ–¹é˜²ç¦¦ä¿‚æ•¸(0~1)</label><input id="gEnemyDef" type="number" value="0.1" step="0.01"></div>
    </div>
    <div class="row">
      <div class="col"><label>å¹³å‡æ“Šæ®ºæ™‚é–“(ç§’)</label><input id="gKillTime" type="number" value="30"></div>
      <div class="col"><label>è£å‚™æˆæœ¬(æ¥“å¹£)</label><input id="gCost" type="number"></div>
      <div class="col"><label>æœŸæœ› ROI æ™‚é–“(å°æ™‚)</label><input id="gROIHours" type="number" value="10"></div>
    </div>
    <div style="margin-top:10px"><button id="btnCalcGear">è¨ˆç®—æ•ˆç›Š</button></div>
    <div id="gearResult" class="result" style="display:none"></div>
  </div>

  <div class="panel" id="about">
    <h3>èªªæ˜</h3>
    <p class="small">æœ¬å·¥å…·æ•´åˆä½ æä¾›çš„ Artale è£œå“è³‡æ–™èˆ‡å…¬å¼ï¼ŒæœƒåŒæ™‚è¨ˆç®— HP/MP è£œå“çš„æ¯æœŸéœ€æ±‚èˆ‡æˆæœ¬ï¼Œä¸¦åœ¨åˆæ ¼è£œå“ä¸­çµ¦å‡º <b>æ•ˆç‡æœ€ä½³</b>ï¼ˆCP å€¼é«˜ï¼‰èˆ‡ <b>æˆæœ¬æœ€ä½åˆæ ¼</b> å…©ç¨®æ¨è–¦ã€‚</p>
  </div>

  <footer>Â© Maple Water åŠ©æ‰‹ â€” Artale æœ€çµ‚ç‰ˆ</footer>
</div>

<script>
/* ------------- DATA ------------- */
/* HP (è˜‹æœ/ç´…è—¥åƒ¹æ ¼å·²ä¿®æ­£ï¼šå…¶é¤˜åœ°åœ–åˆ†åˆ¥ç‚º price 30 / 50) */
const HP_POTIONS = [
  {id:"apple_fw",name:"è˜‹æœ",hp:30,price:28,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"apple_map",name:"è˜‹æœ",hp:30,price:30,where:"å…¶é¤˜åœ°åœ–"},
  {id:"red_fw",name:"ç´…è‰²è—¥æ°´/é›è›‹",hp:50,price:47,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"red_map",name:"ç´…è‰²è—¥æ°´/é›è›‹",hp:50,price:50,where:"å…¶é¤˜åœ°åœ–"},
  {id:"bbq",name:"çƒ¤è‚‰",hp:100,price:106,where:"å…¨è—¥æ°´åº—"},
  {id:"orange_fw",name:"æ©˜è‰²è—¥æ°´",hp:150,price:152,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"orange_map",name:"æ©˜è‰²è—¥æ°´",hp:150,price:160,where:"å…¶é¤˜åœ°åœ–"},
  {id:"chicken_toy",name:"ç‚¸é›",hp:200,price:209,where:"ç©å…·åŸ/æ„›å¡”"},
  {id:"chicken_ant",name:"ç‚¸é›",hp:200,price:220,where:"èèŸ»æ´"},
  {id:"white_fw",name:"ç™½è‰²è—¥æ°´",hp:300,price:304,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"white_quest",name:"ç™½è‰²è—¥æ°´",hp:300,price:310,where:"ç…‰é‡‘è¡“å£«çä»»å‹™"},
  {id:"white_map",name:"ç™½è‰²è—¥æ°´",hp:300,price:320,where:"å…¶é¤˜åœ°åœ–"},
  {id:"hotdog_toy",name:"å¤§ç†±ç‹—",hp:300,price:304,where:"ç©å…·åŸ/æ„›å¡”"},
  {id:"hotdog_ant",name:"å¤§ç†±ç‹—",hp:300,price:320,where:"èèŸ»æ´"},
  {id:"pizza_toy",name:"æŠ«è–©/æ¼¢å ¡",hp:400,price:427,where:"ç©å…·åŸ/æ„›å¡”"},
  {id:"pizza_ant",name:"æŠ«è–©/æ¼¢å ¡",hp:400,price:450,where:"èèŸ»æ´"},
  {id:"hotdogb",name:"ç†±ç‹—å ¡",hp:500,price:503,where:"ç©å…·åŸ/æ„›å¡”"},
  {id:"hotdogb_ant",name:"ç†±ç‹—å ¡",hp:500,price:530,where:"èèŸ»æ´"},
  {id:"eel_fw",name:"çƒ¤é°»é­š",hp:1000,price:1045,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"eel_quest",name:"çƒ¤é°»é­š",hp:1000,price:1060,where:"ç…‰é‡‘è¡“å£«çä»»å‹™"},
  {id:"eel_map",name:"çƒ¤é°»é­š",hp:1000,price:1100,where:"å¥‡å¹»æ‘/.../å…¶ä»–"},
  {id:"eel_love",name:"çƒ¤é°»é­š",hp:1000,price:1144,where:"æ„›å¡”-ç³–æœæ©Ÿ"},
  {id:"popsicle_toy",name:"æ£’å†°æ£’",hp:2000,price:2185,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"popsicle_map",name:"æ£’å†°æ£’",hp:2000,price:2300,where:"å…¶ä»–åœ°åœ–"},
  {id:"cheese_fw",name:"ä¹³é…ª",hp:4000,price:4500,where:"å†°åŸ/ç«¥è©±æ‘/..."},
  {id:"cheese_map",name:"ä¹³é…ª",hp:4000,price:4680,where:"æ„›å¡”/é˜²è¡›..."},
  {id:"reindeer_fw",name:"é¦´é¹¿å¥¶",hp:5000,price:5600,where:"å†°åŸ/é˜²è¡›æœ¬éƒ¨/..."},
  {id:"reindeer_map",name:"é¦´é¹¿å¥¶",hp:5000,price:5824,where:"æ„›å¡”-ç³–æœæ©Ÿ/..." }
];

const MP_POTIONS = [
  {id:"orange",name:"æŸ³æ©™",mp:50,price:95,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"blue_small",name:"è—è‰²è—¥æ°´",mp:100,price:190,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"lemon",name:"æª¸æª¬",mp:150,price:294,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"energy",name:"æ´»åŠ›è—¥æ°´",mp:300,price:589,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"spring",name:"ç¤¦æ³‰æ°´",mp:800,price:1567,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"redice",name:"ç´…è±†åˆ¨å†°",mp:2000,price:3800,where:"ç©å…·åŸ/æ„›å¡”/é˜²è¡›æœ¬éƒ¨"},
  {id:"dawn",name:"æ¸…æ™¨ä¹‹éœ²",mp:4000,price:7695,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"dusk",name:"é»ƒæ˜ä¹‹éœ²",mp:5000,price:9690,where:"é˜²è¡›æœ¬éƒ¨"},
  {id:"choco",name:"å·§å…‹åŠ›",mp:1000,hp:1000,price:3000,where:"ç¶­å¤šåˆ©äºæ¸¯/å¤©åŸ/..." }
];

/* æŠ€èƒ½èˆ‡è¡¨æ ¼è³‡æ–™ï¼ˆä¾†æºï¼šä½ æä¾›çš„æŠ€èƒ½æ•¸å€¼ï¼‰ */
const teleportCost = [0,60,57,54,51,48,45,42,39,36,33,31,29,27,25,23,21,19,17,15,13];
function poisonCost(lv){ if(!lv) return 0; return lv<=15?10:20; }
const deadlyCostArr = (()=>{ const a=[0]; for(let i=1;i<=30;i++) a[i]=20+i; return a; })();
function deadlyCost(lv){ return lv?deadlyCostArr[lv]:0; }

const magicHeart = [null,
  {mp:6,dur:30,replace:0.04},{mp:6,dur:60,replace:0.08},{mp:6,dur:90,replace:0.12},
  {mp:6,dur:120,replace:0.16},{mp:6,dur:150,replace:0.20},{mp:6,dur:180,replace:0.24},
  {mp:6,dur:210,replace:0.28},{mp:6,dur:240,replace:0.32},{mp:6,dur:270,replace:0.36},
  {mp:6,dur:300,replace:0.40},{mp:12,dur:330,replace:0.44},{mp:12,dur:360,replace:0.48},
  {mp:12,dur:390,replace:0.52},{mp:12,dur:420,replace:0.56},{mp:12,dur:450,replace:0.60},
  {mp:12,dur:480,replace:0.64},{mp:12,dur:510,replace:0.68},{mp:12,dur:540,replace:0.72},
  {mp:12,dur:570,replace:0.76},{mp:12,dur:600,replace:0.80}
];
const magicShield = [null,
  {mp:8,dur:20},{mp:8,dur:40},{mp:8,dur:60},{mp:8,dur:80},{mp:8,dur:100},
  {mp:8,dur:120},{mp:8,dur:140},{mp:8,dur:160},{mp:8,dur:180},{mp:8,dur:200},
  {mp:16,dur:220},{mp:16,dur:240},{mp:16,dur:260},{mp:16,dur:280},{mp:16,dur:300},
  {mp:16,dur:320},{mp:16,dur:340},{mp:16,dur:360},{mp:16,dur:380},{mp:16,dur:400}
];

function nf(n){ return (Math.round(n*100)/100).toLocaleString(); }

/* ---------- UI functions ---------- */
function fillWhereSelects(){
  const hpWhere=document.getElementById('hpWhere'), mpWhere=document.getElementById('mpWhere');
  const set=new Set();
  HP_POTIONS.forEach(p=>p.where&&set.add(p.where));
  MP_POTIONS.forEach(p=>p.where&&set.add(p.where));
  Array.from(set).sort().forEach(w=>{ const o=document.createElement('option'); o.value=w; o.textContent=w; hpWhere.appendChild(o); const o2=o.cloneNode(true); mpWhere.appendChild(o2); });
}

function renderHpTable(){
  const tbody=document.querySelector('#hpTable tbody'); tbody.innerHTML='';
  const q=(document.getElementById('hpSearch').value||'').trim().toLowerCase();
  const where=document.getElementById('hpWhere').value;
  const sort=document.getElementById('hpSort').value;
  let data=HP_POTIONS.map(p=>({...p,rate:p.hp/p.price}));
  if(where!=='all') data=data.filter(d=>d.where===where);
  if(q) data=data.filter(d=>(d.name+d.where).toLowerCase().includes(q));
  if(sort==='rate') data.sort((a,b)=>b.rate-a.rate);
  if(sort==='price') data.sort((a,b)=>a.price-b.price);
  if(sort==='hp') data.sort((a,b)=>b.hp-a.hp);
  const best=data.length?data[0]:null;
  data.forEach(d=>{ const tr=document.createElement('tr'); if(best && d.id===best.id) tr.classList.add('highlight'); tr.innerHTML=`<td>${d.name}</td><td>${nf(d.hp)}</td><td>${nf(d.price)}</td><td>${(d.rate).toFixed(3)}</td><td>${d.where}</td>`; tbody.appendChild(tr); });
  document.getElementById('hpNote').textContent = data.length?`å…± ${data.length} é …ï¼ŒCP æœ€ä½³é …ç›®å·²åŠ äº®`:'ç„¡ç¬¦åˆé …ç›®';
}

function renderMpTable(){
  const tbody=document.querySelector('#mpTable tbody'); tbody.innerHTML='';
  const q=(document.getElementById('mpSearch').value||'').trim().toLowerCase();
  const where=document.getElementById('mpWhere').value;
  const sort=document.getElementById('mpSort').value;
  let data=MP_POTIONS.map(p=>({...p,rate:p.mp? (p.mp/p.price) : (p.hp/p.price)}));
  if(where!=='all') data=data.filter(d=>d.where===where);
  if(q) data=data.filter(d=>(d.name+(d.where||'')).toLowerCase().includes(q));
  if(sort==='rate') data.sort((a,b)=>b.rate-a.rate);
  if(sort==='price') data.sort((a,b)=>a.price-b.price);
  if(sort==='mp') data.sort((a,b)=>(b.mp||0)-(a.mp||0));
  const best=data.length?data[0]:null;
  data.forEach(d=>{ const tr=document.createElement('tr'); if(best && d.id===best.id) tr.classList.add('highlight'); tr.innerHTML=`<td>${d.name}</td><td>${d.mp?nf(d.mp):'-'}</td><td>${nf(d.price)}</td><td>${(d.rate||0).toFixed(3)}</td><td>${d.where||''}</td>`; tbody.appendChild(tr); });
  document.getElementById('mpNote').textContent = data.length?`å…± ${data.length} é …ï¼ŒCP æœ€ä½³é …ç›®å·²åŠ äº®`:'ç„¡ç¬¦åˆé …ç›®';
}

/* events and init */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.getElementById(t.dataset.panel).classList.add('active'); }));
document.getElementById('hpSearch').addEventListener('input', renderHpTable);
document.getElementById('hpWhere').addEventListener('change', renderHpTable);
document.getElementById('hpSort').addEventListener('change', renderHpTable);
document.getElementById('mpSearch').addEventListener('input', renderMpTable);
document.getElementById('mpWhere').addEventListener('change', renderMpTable);
document.getElementById('mpSort').addEventListener('change', renderMpTable);

(function init(){
  fillWhereSelects();
  renderHpTable();
  renderMpTable();

  const eHeart=document.getElementById('eHeart'), eShield=document.getElementById('eShield');
  for(let i=0;i<=20;i++){ const o=document.createElement('option'); o.value=i; o.text=i; eHeart.appendChild(o); eShield.appendChild(o); }
  eHeart.value=3; eShield.value=20;

  const tSel=document.getElementById('eTeleLv'), pSel=document.getElementById('ePoisonLv'), dSel=document.getElementById('eDeadlyLv');
  for(let i=0;i<=20;i++){ const o=document.createElement('option'); o.value=i; o.text=i; tSel.appendChild(o); }
  for(let i=0;i<=30;i++){ const o=document.createElement('option'); o.value=i; o.text=i; pSel.appendChild(o); dSel.appendChild(o); }
  tSel.value=5; pSel.value=12; dSel.value=10;

  document.getElementById('btnCalcEff').addEventListener('click', calcEfficiency);
  document.getElementById('btnCalcGear').addEventListener('click', calcGear);
})();

/* calculation core (same logic we agreed) */
function calcEfficiency(){
  const maxHP=Number(document.getElementById('eHP').value||0);
  const maxMP=Number(document.getElementById('eMP').value||0);
  const avgDmg=Number(document.getElementById('eDmg').value||1400);
  const heartLv=Number(document.getElementById('eHeart').value||0);
  const shieldLv=Number(document.getElementById('eShield').value||0);
  const mbOn=document.getElementById('eMB').value==='1';
  const hitsPerMin=Number(document.getElementById('eHits').value||0);
  const mode=document.getElementById('eMode').value;
  const minutes=Math.max(1, Number(document.getElementById('eMinutes').value||60));
  const teleLv=Number(document.getElementById('eTeleLv').value||0);
  const poisonLv=Number(document.getElementById('ePoisonLv').value||0);
  const deadlyLv=Number(document.getElementById('eDeadlyLv').value||0);

  let telePerMin=Number(document.getElementById('eTelePerMin').value||0);
  let poisonPerMin=Number(document.getElementById('ePoisonPerMin').value||0);
  let deadlyPerMin=Number(document.getElementById('eDeadlyPerMin') ? document.getElementById('eDeadlyPerMin').value||0 : 0);
  const preset={tele:5,poison:12,deadly:4};
  if(mode==='678'){ if(!telePerMin) telePerMin=preset.tele; if(!poisonPerMin) poisonPerMin=preset.poison; if(!deadlyPerMin) deadlyPerMin=preset.deadly; }

  const teleCostSingle=(teleLv>=1 && teleLv<=20)?teleportCost[teleLv]:0;
  const poisonCostSingle=poisonCost(poisonLv);
  const deadlyCostSingle=deadlyCost(deadlyLv);
  const mbMul=mbOn?2:1;
  const skillsMpPerMin = Math.ceil((telePerMin*teleCostSingle + poisonPerMin*poisonCostSingle + deadlyPerMin*deadlyCostSingle) * mbMul);

  const mh = magicHeart[heartLv]||{mp:0,dur:1,replace:0};
  const ms = (shieldLv>0)? magicShield[shieldLv] : {mp:0,dur:1};
  const mhMpPerMin = mh.mp/mh.dur*60;
  const msMpPerMin = ms.mp/ms.dur*60;
  const replaceRate = mh.replace||0;
  const mpPerHitFromHeart = Math.ceil(avgDmg * replaceRate);
  const mpFromHitsPerMin = mpPerHitFromHeart * hitsPerMin;

  const totalMpPerMin = Math.ceil(skillsMpPerMin + mhMpPerMin + msMpPerMin + mpFromHitsPerMin);
  const totalMpForPeriod = Math.ceil(totalMpPerMin * (minutes/60) * 60);

  const hpPerHit = Math.ceil(avgDmg * (1 - replaceRate));
  const hpPerMinLost = hpPerHit * hitsPerMin;
  const totalHpForPeriod = Math.ceil(hpPerMinLost * (minutes/60) * 60);

  const hpThreshold = hpPerHit;
  const mpThreshold = Math.max(mpPerHitFromHeart, teleCostSingle, poisonCostSingle, deadlyCostSingle);

  const mpCandidates = MP_POTIONS.filter(p=> (p.mp && p.mp >= mpThreshold) || (p.mp && p.mp>=mpThreshold*0.75));
  const hpCandidates = HP_POTIONS.filter(p=> (p.hp && p.hp >= hpThreshold) || (p.hp && p.hp>=hpThreshold*0.75));

  const finalMpList = mpCandidates.length?mpCandidates:MP_POTIONS.slice();
  const finalHpList = hpCandidates.length?hpCandidates:HP_POTIONS.slice();

  const totalMpNeed = Math.max(0, totalMpForPeriod);
  const mpResults = finalMpList.map(p=>{ const need = p.mp? Math.ceil(totalMpNeed / p.mp) : 0; const cost = need * p.price; const cp = p.mp? (p.mp / p.price) : 0; return {...p,need,cost,cp}; }).sort((a,b)=>b.cp-a.cp);

  const totalHpNeed = Math.max(0, totalHpForPeriod);
  const hpResults = finalHpList.map(p=>{ const need = p.hp? Math.ceil(totalHpNeed / p.hp) : 0; const cost = need * p.price; const cp = p.hp? (p.hp / p.price) : 0; return {...p,need,cost,cp}; }).sort((a,b)=>b.cp-a.cp);

  const bestMp = mpResults[0]||null;
  const cheapestMp = mpResults.slice().sort((a,b)=>a.cost-b.cost)[0]||null;
  const bestHp = hpResults[0]||null;
  const cheapestHp = hpResults.slice().sort((a,b)=>a.cost-b.cost)[0]||null;

  let out = `<h3>è¨ˆç®—çµæœï¼ˆ${minutes} åˆ†é˜ï¼‰</h3>`;
  out += `<b>åƒæ•¸</b>ï¼šMaxHP ${nf(maxHP)}, MaxMP ${nf(maxMP)}, å¹³å‡å‚·å®³ ${nf(avgDmg)}, æ¯åˆ†é˜è¢«æ‰“ ${nf(hitsPerMin)} æ¬¡<br>`;
  out += `<b>é­”å¿ƒ Lv${heartLv}</b> æ›¿ä»£ç‡ ${(replaceRate*100).toFixed(1)}%ï¼Œé­”å¿ƒæ¯åˆ†é˜è€— MP ${nf(mhMpPerMin)}ï¼›é­”ç›¾æ¯åˆ†é˜è€— MP ${nf(msMpPerMin)}<br>`;
  out += `<hr>`;
  out += `<b>æŠ€èƒ½æ¯åˆ†é˜è€— MP</b>ï¼š${nf(skillsMpPerMin)} MPï¼›<b>è¢«æ‰“è½‰ MP æ¯åˆ†é˜</b>ï¼š${nf(mpFromHitsPerMin)} MP<br>`;
  out += `<h4>â†’ æ¯åˆ†é˜ç¸½è€— MPï¼š ${nf(totalMpPerMin)} MPï¼›åœ¨ ${minutes} åˆ†é˜å…§éœ€ ${nf(totalMpNeed)} MP</h4>`;
  out += `<b>æ¯åˆ†é˜ HP æå¤±ï¼ˆä¼°ï¼‰</b>ï¼š${nf(hpPerMinLost)} HPï¼Œ${minutes} åˆ†é˜å…§ç´„ ${nf(totalHpForPeriod)} HP æå¤±<br>`;
  out += `<hr>`;
  out += `<h4>æœ€ä½æœ‰æ•ˆé–€æª»</h4>`;
  out += `HP é–€æª»ï¼ˆå–®æ¬¡ï¼‰: ${nf(hpThreshold)} HPï¼›MP é–€æª»ï¼ˆå–®æ¬¡ï¼‰: ${nf(mpThreshold)} MP<br>`;
  out += `<hr>`;

  out += `<h3>MP è£œå“ï¼ˆåˆæ ¼å€™é¸ï¼‰</h3>`;
  if(mpResults.length){
    out += `<table><tr><th>è£œå“</th><th>MP</th><th>åƒ¹æ ¼</th><th>æ¯æœŸéœ€æ•¸</th><th>ç¸½åƒ¹</th><th>CP(MP/é‡‘å¹£)</th></tr>`;
    mpResults.forEach(p=>{ out+=`<tr${bestMp && p.id===bestMp.id? ' class="highlight"':''}><td>${p.name}</td><td>${nf(p.mp)}</td><td>${nf(p.price)}</td><td>${nf(p.need)}</td><td>${nf(p.cost)}</td><td>${p.cp.toFixed(3)}</td></tr>`; });
    out += `</table>`;
    out += `<p>ğŸ¥‡ æ•ˆç‡æœ€ä½³ï¼ˆMP/é‡‘å¹£ï¼‰ï¼š<b>${bestMp.name}</b>ï¼Œéœ€ ${nf(bestMp.need)}ï¼Œå…± ${nf(bestMp.cost)}</p>`;
    out += `<p>ğŸ’¸ æˆæœ¬æœ€ä½åˆæ ¼ï¼ˆMPï¼‰ï¼š<b>${cheapestMp.name}</b>ï¼Œéœ€ ${nf(cheapestMp.need)}ï¼Œå…± ${nf(cheapestMp.cost)}</p>`;
  } else out+=`<p>æ‰¾ä¸åˆ°åˆæ ¼ MP è£œå“</p>`;

  out += `<hr><h3>HP è£œå“ï¼ˆåˆæ ¼å€™é¸ï¼‰</h3>`;
  if(hpResults.length){
    out += `<table><tr><th>è£œå“</th><th>HP</th><th>åƒ¹æ ¼</th><th>æ¯æœŸéœ€æ•¸</th><th>ç¸½åƒ¹</th><th>CP(HP/é‡‘å¹£)</th></tr>`;
    hpResults.forEach(p=>{ out+=`<tr${bestHp && p.id===bestHp.id? ' class="highlight"':''}><td>${p.name}</td><td>${nf(p.hp)}</td><td>${nf(p.price)}</td><td>${nf(p.need)}</td><td>${nf(p.cost)}</td><td>${p.cp.toFixed(3)}</td></tr>`; });
    out += `</table>`;
    out += `<p>ğŸ¥‡ æ•ˆç‡æœ€ä½³ï¼ˆHP/é‡‘å¹£ï¼‰ï¼š<b>${bestHp.name}</b>ï¼Œéœ€ ${nf(bestHp.need)}ï¼Œå…± ${nf(bestHp.cost)}</p>`;
    out += `<p>ğŸ’¸ æˆæœ¬æœ€ä½åˆæ ¼ï¼ˆHPï¼‰ï¼š<b>${cheapestHp.name}</b>ï¼Œéœ€ ${nf(cheapestHp.need)}ï¼Œå…± ${nf(cheapestHp.cost)}</p>`;
  } else out+=`<p>æ‰¾ä¸åˆ°åˆæ ¼ HP è£œå“</p>`;

  out += `<p class="small">å‚™è¨»ï¼šè‹¥ä½ æƒ³è¦æ›´ä¿å®ˆçš„é–€æª»ï¼ˆä¾‹å¦‚è£œè¶³ 1.2x å–®æ¬¡å‚·å®³ï¼‰ï¼Œå¯å‘Šè¨´æˆ‘ï¼Œæˆ‘æœƒæŠŠé–€æª»æ”¹æˆä¹˜ä¸Šä¿‚æ•¸å†è¨ˆç®—ã€‚</p>`;

  const el=document.getElementById('effResult'); el.style.display='block'; el.innerHTML=out;
}

/* è£å‚™æ•ˆç›Šï¼ˆç°¡æ˜“ï¼‰ */
function calcGear(){
  const base=Number(document.getElementById('gBaseAtk').value||0);
  const add=Number(document.getElementById('gAddAtk').value||0);
  const def=Math.min(1,Math.max(0,Number(document.getElementById('gEnemyDef').value||0.1)));
  const killTime=Number(document.getElementById('gKillTime').value||30);
  const cost=Number(document.getElementById('gCost').value||0);
  if(!base){ alert('è«‹è¼¸å…¥ç•¶å‰é­”æ”»'); return; }
  const dmgBase=Math.max(0,(base*(1-def)));
  const dmgNew=Math.max(0,((base+add)*(1-def)));
  const dpsBase=dmgBase/killTime; const dpsNew=dmgNew/killTime; const dpsGain=dpsNew-dpsBase;
  const extraKillsPerHour = dpsGain>0 ? (dpsGain*3600 / Math.max(1,dmgNew)) : 0;
  const pseudoValuePerKill = 1;
  const extraIncomePerHour = extraKillsPerHour * pseudoValuePerKill;
  const hoursToROI = extraIncomePerHour>0? (cost/extraIncomePerHour): Infinity;
  let out=`<h3>è£å‚™æ•ˆç›Šçµæœï¼ˆç°¡æ˜“ç¤ºæ„ï¼‰</h3>`;
  out+=`ç•¶å‰å¯¦è³ªå‚·å®³ï¼ˆåƒè€ƒï¼‰: ${nf(dmgBase)}ï¼›æå‡å¾Œ: ${nf(dmgNew)}<br>`;
  out+=`DPSï¼ˆä¼°ï¼‰ï¼š${nf(dpsBase)} â†’ ${nf(dpsNew)}ï¼ˆå¢åŠ  ${nf(dpsGain)}ï¼‰<br>`;
  out+=`ä¼°è¨ˆæ¯å°æ™‚ç›¸å°é¡å¤–æ“Šæ®ºæ•¸ï¼š${nf(extraKillsPerHour)}ï¼ˆç¤ºæ„ï¼‰<br>`;
  out+=`å›æœ¬æ™‚é–“ï¼ˆå°æ™‚ï¼Œç¤ºæ„ï¼‰: ${isFinite(hoursToROI)? nf(hoursToROI):'ç„¡æ³•ä¼°ç®—'}<br>`;
  out+=`<p class="small">èªªæ˜ï¼šæ­¤ç‚ºç°¡åŒ–æ¨¡å‹ï¼Œéœ€å¯¦éš›æ¯æ¬¡æ“Šæ®ºæ”¶ç›Šæ‰èƒ½å¾—å‡ºçœŸå¯¦ ROIã€‚</p>`;
  const el=document.getElementById('gearResult'); el.style.display='block'; el.innerHTML=out;
}
</script>
</body>
</html>
