<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>楓之谷補水效率助手（Artale版）｜法師（火毒）</title>
<style>
  :root{
    --bg:#0b1020;--card:#101935;--muted:#8ea0c7;--fg:#e9efff;--acc:#7bdcff;--grid:#1c2647;
    --ok:#2fd67f;--warn:#f7bf45;--bad:#ff6b6b
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
  a{color:var(--acc);text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
  .brand h1{font-size:20px;margin:0}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .grid{grid-template-columns: 1fr 1fr } }
  .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:14px}
  .card h2{margin:2px 0 10px;font-size:16px}
  .row{display:grid;grid-template-columns: 1fr 1fr; gap:8px}
  .row3{display:grid;grid-template-columns: repeat(3,1fr); gap:8px}
  .row4{display:grid;grid-template-columns: repeat(4,1fr); gap:8px}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--grid);background:#0e1730;color:var(--fg);font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--grid);border-radius:999px;font-size:12px;color:var(--muted);margin-right:6px;margin-bottom:6px}
  .result{display:grid;grid-template-columns:1fr;gap:8px}
  .callout{border-left:4px solid var(--acc);background:#0f1a39;padding:10px 12px;border-radius:8px}
  .ok{border-left-color:var(--ok)}
  .warn{border-left-color:var(--warn)}
  .bad{border-left-color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;font-size:13px;padding:8px 10px;background:#0e1730;border:1px solid var(--grid)}
  th{color:#b9c8ef;background:#0c1630}
  tr>td:first-child, tr>th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr>td:last-child, tr>th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#14224a;border:1px solid var(--grid);font-size:12px;margin-left:6px}
  .btn{background:linear-gradient(180deg,#2a74ff,#2156c9);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .footer{margin:16px 0 40px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 13c4 0 7-3 7-7 0 0 0 0 0 0 0 4 3 7 7 7 0 0 0 0 0 0-4 0-7 3-7 7 0 0 0 0 0 0 0-4-3-7-7-7Z" fill="#7BDcff"/></svg>
      <div>
        <h1>楓之谷補水效率助手（Artale版）</h1>
        <div class="subtitle">法師（火毒）｜%自動補建議、678理論、最省補品搭配</div>
      </div>
    </div>

    <!-- 基本輸入 -->
    <div class="grid">
      <div class="card">
        <h2>角色與環境</h2>
        <div class="row">
          <div>
            <label>最大 HP</label>
            <input id="maxHP" type="number" min="1" value="1200" />
          </div>
          <div>
            <label>最大 MP</label>
            <input id="maxMP" type="number" min="1" value="7000" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>被撞 / 被打：單次傷害（估值）</label>
            <input id="hitDmg" type="number" min="1" value="1350" />
          </div>
          <div>
            <label>自動補策略</label>
            <select id="autoMode">
              <option value="678" selected>678 理論（建議）</option>
              <option value="700">MP目標 700（扣到就補）</option>
              <option value="800">MP目標 800（扣到就補）</option>
              <option value="manual">手動輸入 % 門檻</option>
            </select>
          </div>
        </div>
        <div class="row" id="manualRow" style="margin-top:8px; display:none">
          <div>
            <label>自動補 HP％ 門檻</label>
            <input id="hpPctManual" type="number" min="1" max="99" value="80" />
          </div>
          <div>
            <label>自動補 MP％ 門檻</label>
            <input id="mpPctManual" type="number" min="1" max="99" value="10" />
          </div>
        </div>
        <div class="help" style="margin-top:8px">
          註：678 模式會自動用 ⌊678 / 最大MP⌋% 作為 MP 自動補門檻，並建議 HP％ 依你被打的實損估值配置。
        </div>
      </div>

      <!-- 技能 -->
      <div class="card">
        <h2>技能等級（可互動）</h2>
        <div class="row4">
          <div>
            <label>魔心防禦 Lv.</label>
            <select id="mgLv"></select>
          </div>
          <div>
            <label>魔力之盾 Lv.</label>
            <select id="maLv"></select>
          </div>
          <div>
            <label>瞬間移動 Lv.</label>
            <select id="teleLv"></select>
          </div>
          <div>
            <label>魔力激發 Lv.</label>
            <select id="ampLv"></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>毒霧 Lv.</label>
            <select id="poisonMistLv"></select>
          </div>
          <div>
            <label>致命毒霧 Lv.</label>
            <select id="poisonFogLv"></select>
          </div>
        </div>
        <div class="help" style="margin-top:8px">
          本工具只計入技能「耗魔/耗血」與「魔心替代率」對補水的影響；技能實際傷害、命中、範圍不納入計算。
        </div>
      </div>
    </div>

    <!-- 價格來源 -->
    <div class="card" style="margin-top:12px">
      <h2>補品價格來源</h2>
      <div class="row">
        <div>
          <label>價格模式</label>
          <select id="priceMode">
            <option value="min" selected>用最低價（經濟實惠）</option>
            <option value="loc">指定地點價格</option>
          </select>
        </div>
        <div>
          <label>指定地點（選此項需搭配「指定地點價格」）</label>
          <select id="priceLoc" disabled></select>
        </div>
      </div>
      <div class="help" style="margin-top:8px">
        可切換「用最低價」或「指定地點」。若選指定地點，以下推薦計算與表格都會以該地點價格為準。
      </div>
    </div>

    <!-- 計算結果 -->
    <div class="grid" style="margin-top:12px">
      <div class="card">
        <h2>建議自動補門檻 & 每刀實際消耗</h2>
        <div class="result" id="summary">
          <!-- JS 動態填入 -->
        </div>
        <div style="margin-top:10px">
          <button class="btn" id="recalc">重新計算</button>
        </div>
      </div>

      <div class="card">
        <h2>推薦補品組合（最省）</h2>
        <div id="reco">
          <!-- JS 動態填入 -->
        </div>
      </div>
    </div>

    <!-- 補品表 -->
    <div class="card" style="margin-top:12px">
      <h2>補品資料（Artale 版）<span class="badge" id="badgePriceMode">最低價</span></h2>
      <div class="help">CP 值＝補量 / 價格（同品多地點會顯示當前價格模式下的補量／價格／轉換率）</div>

      <h3 style="margin:14px 0 6px">HP 藥水</h3>
      <div id="hpTable"></div>

      <h3 style="margin:14px 0 6px">MP 藥水</h3>
      <div id="mpTable"></div>

      <h3 style="margin:14px 0 6px">綜合（同時補 HP&MP）</h3>
      <div id="mixTable"></div>
    </div>

    <div class="footer">
      版本：Artale-整合最終版。資料源：你提供的表（含多地點價）。計算僅供參考，實戰請以自身機體與地圖狀況微調。
    </div>
  </div>

<script>
/* ========= 資料區：技能表 ========= */
// 魔心防禦（Magic Guard）替代率 & 維護耗魔（套用你提供的表）
const MAGIC_GUARD = Array.from({length:20}, (_,i)=>{
  const lv=i+1;
  const ratio=[4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80][i];
  const mpCost = lv<=10?6:12;
  const durSec = [30,60,90,120,150,180,210,240,270,300,330,360,390,420,450,480,510,540,570,600][i];
  return {lv, ratio, mpCost, durSec};
});

// 魔力之盾（Magic Armor）
const MAGIC_ARMOR = Array.from({length:20}, (_,i)=>{
  const lv=i+1;
  const mpCost = lv<=10?8:16;
  const durSec = [20,40,60,80,100,120,140,160,180,200,220,240,260,280,300,320,340,360,380,400][i];
  const def = 2*lv;
  return {lv, mpCost, durSec, def};
});

// 瞬間移動（MP）
const TELEPORT = Array.from({length:20}, (_,i)=>{
  const lv=i+1;
  const mp = [60,57,54,51,48,45,42,39,36,33,31,29,27,25,23,21,19,17,15,13][i];
  return {lv, mp};
});

// 毒霧（2轉）
const POISON_MIST = Array.from({length:30}, (_,i)=>{
  const lv=i+1;
  const mp = lv<=15?10:20;
  return {lv, mp};
});

// 致命毒霧（3轉）
const POISON_FOG = Array.from({length:30}, (_,i)=>{
  const lv=i+1;
  const mp = 20+lv; // 1→21, 30→50（照表）
  return {lv, mp};
});

// 極速詠唱（每次施放耗血/耗魔）
const SPELL_BOOST = Array.from({length:20},(_,i)=>{
  const lv=i+1;
  const hp=[58,56,54,52,50,48,46,44,42,40,39,38,37,36,35,34,33,32,31,30][i];
  const mp=[53,51,49,47,45,43,41,39,37,35,34,33,32,31,30,29,28,27,26,25][i];
  return {lv,hp,mp};
});

// 魔力激發（耗魔倍率）
const AMP_MAGIC = Array.from({length:30},(_,i)=>{
  const lv=i+1;
  const costPct=[105,110,115,120,125,130,135,140,145,150,160,155,165,160,170,165,175,170,180,175,185,180,190,185,195,190,205,200,195,200][i];
  const dmgPct=[107,109,111,113,114,115,116,117,118,119,121,121,123,123,125,125,127,127,129,129,131,131,133,133,135,135,137,137,137,140][i];
  return {lv,costPct,dmgPct};
});

/* ========= 資料區：補品（Artale 版，多地點） =========
   備註：每個項目以 {name, amount, prices: {地點:價格}} 表示。
   轉換率= amount / 使用價格（會依當前模式取用最低或指定地點）
*/

const HP_POTS = [
  {name:"蘋果", amount:30, prices:{ "防衛本部":28, "其餘地圖":30 }},
  {name:"紅色藥水/雞蛋", amount:50, prices:{ "玩具城/糖果機/防衛本部":47, "其餘地圖":50 }},
  {name:"烤肉", amount:100, prices:{ "全藥水店均一價":106 }},
  {name:"橘色藥水", amount:150, prices:{ "玩具城/糖果機/防衛本部":152, "其餘地圖":160 }},
  {name:"炸雞", amount:200, prices:{ "玩具城/糖果機":209, "螞蟻洞":220 }},
  {name:"白色藥水", amount:300, prices:{ "玩具城/糖果機/防衛本部":304, "煉金術士珍任務":310, "其餘地圖":320 }},
  {name:"大熱狗", amount:300, prices:{ "玩具城/糖果機":304, "螞蟻洞":320 }},
  {name:"披薩/漢堡", amount:400, prices:{ "玩具城/糖果機":427, "螞蟻洞":450 }},
  {name:"熱狗堡", amount:500, prices:{ "玩具城/糖果機":503, "螞蟻洞":530 }},
  {name:"烤鰻魚", amount:1000, prices:{ "防衛本部":1045, "煉金術士珍任務":1060, "多地區通用價":1100, "愛塔-糖果機":1144 }},
  {name:"棒冰棒", amount:2000, prices:{ "玩具城/糖果機/防衛本部":2185, "多地區通用價":2300 }},
  {name:"乳酪", amount:4000, prices:{ "冰原/童話村/不夜城/桃花仙境":4500, "愛塔/防衛本部/時間通道":4680 }},
  {name:"馴鹿奶", amount:5000, prices:{ "冰原/防衛本部/童話村/不夜城/桃花仙境":5600, "愛塔-糖果機/時間通道":5824 }},
];

const MP_POTS = [
  {name:"柳橙", amount:50, prices:{ "防衛本部":95, "魔森":97, "其餘地圖":100 }},
  {name:"藍色藥水", amount:100, prices:{ "玩具城/糖果機/防衛本部":190, "魔森":192, "其餘地圖":200 }},
  {name:"檸檬", amount:150, prices:{ "防衛本部":294, "魔森":305, "其餘地圖":310 }},
  {name:"沙拉", amount:200, prices:{ "螞蟻洞":420 }},
  {name:"活力藥水", amount:300, prices:{ "玩具城/糖果機/防衛本部":589, "魔森":604, "其餘地圖":620 }},
  {name:"礦泉水", amount:800, prices:{ "防衛本部":1567, "煉金術士珍任務":1600, "多地區通用價":1650, "愛塔-糖果機":1716 }},
  {name:"紅豆刨冰", amount:2000, prices:{ "玩具城/糖果機/防衛本部":3800, "多地區通用價":4000 }},
  {name:"清晨之露", amount:4000, prices:{ "防衛本部":7695, "冰原/童話村/時間通道/不夜城/桃花仙境":8100, "愛塔-糖果機":8424 }},
  {name:"黃昏之露", amount:5000, prices:{ "防衛本部":9690, "冰原/童話村/時間通道/不夜城/桃花仙境":10200, "愛塔-糖果機":10608 }},
];

const MIX_POTS = [
  {name:"巧克力(1000/1000)", hp:1000, mp:1000, prices:{ "一般":3000, "玩具城":2850 }},
  {name:"蛋糕(100/100)", hp:100, mp:100, prices:{ "玩具城/糖果機":304, "螞蟻洞":320 }},
  {name:"西瓜(1000/1000)", hp:1000, mp:1000, prices:{ "防衛本部":3034, "煉金術士珍任務":3120, "多地區通用價":3200 }},
];

/* ========= UI：選單初始化 ========= */
function fillSelect(id, max){
  const el=document.getElementById(id);
  el.innerHTML="";
  for(let i=1;i<=max;i++){
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=i;
    el.appendChild(opt);
  }
}
fillSelect("mgLv",20);
fillSelect("maLv",20);
fillSelect("teleLv",20);
fillSelect("ampLv",30);
fillSelect("poisonMistLv",30);
fillSelect("poisonFogLv",30);

const priceLocSel=document.getElementById("priceLoc");
const ALL_LOCS = Array.from(new Set([
  ...HP_POTS.flatMap(p=>Object.keys(p.prices)),
  ...MP_POTS.flatMap(p=>Object.keys(p.prices)),
  ...MIX_POTS.flatMap(p=>Object.keys(p.prices))
]));
ALL_LOCS.forEach(loc=>{
  const opt=document.createElement("option");
  opt.value=loc; opt.textContent=loc;
  priceLocSel.appendChild(opt);
});
priceLocSel.value=ALL_LOCS[0];

/* ========= 價格模式切換 ========= */
const priceModeSel=document.getElementById("priceMode");
priceModeSel.addEventListener("change", ()=>{
  const isLoc=priceModeSel.value==="loc";
  priceLocSel.disabled=!isLoc;
  document.getElementById("badgePriceMode").textContent=isLoc?`指定地點：${priceLocSel.value}`:"最低價";
  renderTables();
  recalcAll();
});
priceLocSel.addEventListener("change", ()=>{
  document.getElementById("badgePriceMode").textContent=`指定地點：${priceLocSel.value}`;
  renderTables();
  recalcAll();
});

/* ========= 自動補模式 ========= */
const autoModeSel=document.getElementById("autoMode");
autoModeSel.addEventListener("change", ()=>{
  document.getElementById("manualRow").style.display = autoModeSel.value==="manual" ? "" : "none";
  recalcAll();
});

/* ========= 工具函式 ========= */
function pickPrice(prices){
  if(priceModeSel.value==="min"){
    return Math.min(...Object.values(prices));
  }else{
    const loc=priceLocSel.value;
    return (loc in prices)? prices[loc] : Math.min(...Object.values(prices));
  }
}
function cp(amount, price){ return amount/price; }
function fmtPct(n){ return `${n}%`; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function floor(n){ return Math.floor(n); }

/* ========= 計算：每刀實損、推薦門檻 ========= */
function calcHitLoss(hit, mgLv){
  const mg = MAGIC_GUARD[mgLv-1]??{ratio:0};
  const r = mg.ratio/100; // 0~0.8
  const mpLoss = hit * r;
  const hpLoss = hit * (1-r);
  return {hpLoss, mpLoss, mgRatio:mg.ratio};
}

function suggestThresholds(maxHP,maxMP,hit, mgLv, mode, manualHPpct, manualMPpct){
  const loss = calcHitLoss(hit, mgLv);
  let mpPct, hpPct, note=[];
  if(mode==="678"){
    mpPct = floor((678/maxMP)*100);
    note.push("678理論：自動補MP=⌊678/最大MP⌋%");
  }else if(mode==="700"){
    mpPct = floor((700/maxMP)*100);
    note.push("目標700策略：自動補MP≈700/最大MP");
  }else if(mode==="800"){
    mpPct = floor((800/maxMP)*100);
    note.push("目標800策略：自動補MP≈800/最大MP");
  }else{
    mpPct = clamp(floor(manualMPpct),1,99);
    note.push("手動MP門檻");
  }
  // HP％：讓被打一刀通常會低於門檻以觸發補血（多留1%容錯）
  const hpAfterHitPct = floor(((maxHP - loss.hpLoss)/maxHP)*100);
  hpPct = clamp(Math.min(99, Math.max(1, hpAfterHitPct+1)),1,99);
  if(mode==="manual"){
    hpPct = clamp(floor(manualHPpct),1,99);
    note.unshift("手動HP門檻");
  }else{
    note.push("HP門檻以被打一刀後略低於門檻為原則 (+1% 緩衝)");
  }
  return {hpPct, mpPct, loss, note: note.join("；")};
}

/* ========= 推薦補品：最省又能「接住」消耗 ========= */
function bestHpPot(needHP){
  // 找「價格最低且補量 >= 需要量」；若沒有，取補量最大的那個（成本最低 / 1000量）
  let candidates=[];
  for(const p of HP_POTS){
    const price=pickPrice(p.prices);
    candidates.push({name:p.name, amount:p.amount, price, cp:cp(p.amount,price)});
  }
  // 先找能單瓶補到 ≥ needHP，取價格最便宜
  const enough = candidates.filter(c=>c.amount>=needHP).sort((a,b)=>a.price-b.price || b.cp-a.cp);
  if(enough.length) return enough[0];
  // 否則取 CP 值最高的（每 1000 量最便宜）
  return candidates.sort((a,b)=> (b.cp - a.cp) || (a.price-b.price))[0];
}

function bestMpPot(needMP){
  let candidates=[];
  for(const p of MP_POTS){
    const price=pickPrice(p.prices);
    candidates.push({name:p.name, amount:p.amount, price, cp:cp(p.amount,price)});
  }
  const enough = candidates.filter(c=>c.amount>=needMP).sort((a,b)=>a.price-b.price || b.cp-a.cp);
  if(enough.length) return enough[0];
  return candidates.sort((a,b)=> (b.cp - a.cp) || (a.price-b.price))[0];
}

/* ========= 重新計算 ========= */
function recalcAll(){
  const maxHP = +document.getElementById("maxHP").value||1;
  const maxMP = +document.getElementById("maxMP").value||1;
  const hitDmg = +document.getElementById("hitDmg").value||0;

  const mgLv = +document.getElementById("mgLv").value||1;
  const maLv = +document.getElementById("maLv").value||1;
  const teleLv = +document.getElementById("teleLv").value||1;
  const ampLv = +document.getElementById("ampLv").value||1;
  const mistLv = +document.getElementById("poisonMistLv").value||1;
  const fogLv = +document.getElementById("poisonFogLv").value||1;

  const manualHPpct= +document.getElementById("hpPctManual").value||80;
  const manualMPpct= +document.getElementById("mpPctManual").value||10;
  const mode=autoModeSel.value;

  const {hpPct, mpPct, loss, note} = suggestThresholds(maxHP,maxMP,hitDmg,mgLv,mode, manualHPpct, manualMPpct);

  // 估算一次「被打一刀 → 觸發補」後，希望補回的量：
  // HP 目標：補到超過門檻（抓到滿或到安全），取需要量 = max(門檻%*maxHP - (maxHP - hpLoss), 0)
  const hpAfter = maxHP - loss.hpLoss;
  const hpTarget = Math.ceil(hpPct/100 * maxHP);
  const needHP = Math.max(hpTarget - hpAfter, 0);

  // MP 目標：依模式（678/700/800/手動）估回到該門檻以上；也考慮瞬移與毒系技能連放的緩衝（簡化抓 2*瞬移 + 2*致命毒霧）
  const mpAfter = maxMP - loss.mpLoss;
  let mpTarget = Math.ceil(mpPct/100 * maxMP);
  // 緩衝：2*瞬移 + 2*致命毒霧
  const teleMP = TELEPORT[teleLv-1].mp;
  const fogMP = POISON_FOG[fogLv-1].mp;
  const buffer = 2*teleMP + 2*fogMP; // 與 678 理念一致：至少能多放幾下再補
  mpTarget += buffer;
  mpTarget = Math.min(mpTarget, maxMP);
  const needMP = Math.max(mpTarget - mpAfter, 0);

  const hpPick = bestHpPot(needHP);
  const mpPick = bestMpPot(needMP);

  // 技能維護耗魔預估（每分鐘；只列出會持續的）
  const mg = MAGIC_GUARD[mgLv-1];
  const ma = MAGIC_ARMOR[maLv-1];
  const mgPerMin = mg ? mg.mpCost * (60 / (mg.durSec||60)) : 0;
  const maPerMin = ma ? ma.mpCost * (60 / (ma.durSec||60)) : 0;

  // 施放技能單次耗魔（受魔力激發影響）
  const amp = AMP_MAGIC[ampLv-1]||{costPct:100};
  const ampRate = (amp.costPct||100)/100;
  const teleOnce = TELEPORT[teleLv-1].mp * ampRate;
  const mistOnce = POISON_MIST[mistLv-1].mp * ampRate;
  const fogOnce  = POISON_FOG[fogLv-1].mp * ampRate;
  const boost = SPELL_BOOST[9]; // 取Lv10示意? 不，顯示對照表，這裡不自動續；費用在上面 buffer 已考慮連放緩衝即可。

  // 輸出
  const sum = document.getElementById("summary");
  sum.innerHTML = `
    <div class="callout ok">
      <div>🛡️ 魔心替代率：<b>${mg?.ratio||0}%</b>（Lv.${mgLv}，維護：${mg?.mpCost||0} MP / ${mg?.durSec||0}s）</div>
      <div>🧷 魔力之盾：Lv.${maLv}（維護：${ma?.mpCost||0} MP / ${ma?.durSec||0}s）</div>
    </div>
    <div class="callout">
      <div>💥 每刀實損 ≈ <b>HP ${Math.round(loss.hpLoss)}</b>、<b>MP ${Math.round(loss.mpLoss)}</b></div>
      <div class="muted">（以輸入的單次傷害 ${hitDmg} 與魔心比例 ${mg?.ratio||0}% 計算）</div>
    </div>
    <div class="callout">
      <div>🧮 建議自動補門檻：HP <b>${fmtPct(hpPct)}</b>、MP <b>${fmtPct(mpPct)}</b></div>
      <div class="muted">${note}</div>
    </div>
    <div class="callout">
      <div>🧱 技能維護耗魔（估每分鐘）：魔心 ${mgPerMin.toFixed(1)} MP / min、魔盾 ${maPerMin.toFixed(1)} MP / min</div>
      <div class="muted">瞬移單次 ${Math.round(teleOnce)} MP、毒霧單次 ${Math.round(mistOnce)} MP、致命毒霧單次 ${Math.round(fogOnce)} MP（含魔力激發倍率）</div>
    </div>
  `;

  const reco = document.getElementById("reco");
  const hpCp1000 = (1000 * hpPick.price / hpPick.amount).toFixed(1);
  const mpCp1000 = (1000 * mpPick.price / mpPick.amount).toFixed(1);
  reco.innerHTML = `
    <div class="callout ok">
      <div>✅ 推薦 HP 補品：<b>${hpPick.name}</b>（補 ${hpPick.amount}，$${hpPick.price}，CP=${(hpPick.amount/hpPick.price).toFixed(3)}）<br/>
      估計需要補回：<b>${Math.round(needHP)}</b> ⇒ 單瓶可接住：${hpPick.amount>=needHP ? "是" : "否"} <span class="badge">每1000量 ≈ $${hpCp1000}</span></div>
    </div>
    <div class="callout ok">
      <div>✅ 推薦 MP 補品：<b>${mpPick.name}</b>（補 ${mpPick.amount}，$${mpPick.price}，CP=${(mpPick.amount/mpPick.price).toFixed(3)}）<br/>
      估計需要補回：<b>${Math.round(needMP)}</b> ⇒ 單瓶可接住：${mpPick.amount>=needMP ? "是" : "否"} <span class="badge">每1000量 ≈ $${mpCp1000}</span></div>
      <div class="muted" style="margin-top:6px">說明：MP 會加上「2×瞬移 + 2×致命毒霧」的緩衝量，以避免一補就連續觸發浪費；若你偏好極致省水，可把自動補門檻再調低 1–2%。</div>
    </div>
  `;
}

/* ========= 表格渲染 ========= */
function renderTable(containerId, headers, rows){
  const el=document.getElementById(containerId);
  const table=document.createElement("table");
  const thead=document.createElement("thead");
  const trh=document.createElement("tr");
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    r.forEach((c,i)=>{
      const td=document.createElement("td");
      td.innerHTML=c;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  el.innerHTML="";
  el.appendChild(table);
}

function renderTables(){
  const isLoc = priceModeSel.value==="loc";
  const loc = priceLocSel.value;
  // HP
  const hpRows = HP_POTS.map(p=>{
    const price = pickPrice(p.prices);
    const locUsed = Object.keys(p.prices).find(k=>p.prices[k]===price) || "-";
    return [p.name, p.amount, price, (p.amount/price).toFixed(3), isLoc? loc : `最低價於「${locUsed}」`];
  });
  renderTable("hpTable", ["藥水名","補量(HP)","價格","轉換率","購買地"], hpRows);

  // MP
  const mpRows = MP_POTS.map(p=>{
    const price = pickPrice(p.prices);
    const locUsed = Object.keys(p.prices).find(k=>p.prices[k]===price) || "-";
    return [p.name, p.amount, price, (p.amount/price).toFixed(3), isLoc? loc : `最低價於「${locUsed}」`];
  });
  renderTable("mpTable", ["藥水名","補量(MP)","價格","轉換率","購買地"], mpRows);

  // MIX
  const mixRows = MIX_POTS.map(p=>{
    const price = pickPrice(p.prices);
    const locUsed = Object.keys(p.prices).find(k=>p.prices[k]===price) || "-";
    const amt = `${p.hp}&${p.mp}`;
    const ratio = ((p.hp+p.mp)/price).toFixed(3);
    return [p.name, amt, price, ratio, isLoc? loc : `最低價於「${locUsed}」`];
  });
  renderTable("mixTable", ["藥水名","補量(HP&MP)","價格","比值","購買地"], mixRows);
}

/* ========= 事件與初始渲染 ========= */
document.getElementById("recalc").addEventListener("click", recalcAll);
document.getElementById("mgLv").addEventListener("change", recalcAll);
document.getElementById("maLv").addEventListener("change", recalcAll);
document.getElementById("teleLv").addEventListener("change", recalcAll);
document.getElementById("ampLv").addEventListener("change", recalcAll);
document.getElementById("poisonMistLv").addEventListener("change", recalcAll);
document.getElementById("poisonFogLv").addEventListener("change", recalcAll);
document.getElementById("maxHP").addEventListener("input", recalcAll);
document.getElementById("maxMP").addEventListener("input", recalcAll);
document.getElementById("hitDmg").addEventListener("input", recalcAll);
document.getElementById("hpPctManual").addEventListener("input", recalcAll);
document.getElementById("mpPctManual").addEventListener("input", recalcAll);

renderTables();
recalcAll();
</script>
</body>
</html>
