<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ¥“ä¹‹è°·è£œæ°´æ•ˆç‡åŠ©æ‰‹ï¼ˆArtaleç‰ˆï¼‰ï½œæ³•å¸«ï¼ˆç«æ¯’ï¼‰</title>
<style>
  :root{--bg:#0b1020;--card:#101935;--muted:#8ea0c7;--fg:#e9efff;--acc:#7bdcff;--grid:#1c2647;--ok:#2fd67f;--warn:#f7bf45;--bad:#ff6b6b}
  *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans"}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
  .brand h1{font-size:20px;margin:0}
  .subtitle{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:960px){ .grid{grid-template-columns: 1fr 1fr } }
  .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:14px}
  .card h2{margin:2px 0 10px;font-size:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  label{font-size:12px;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--grid);background:#0e1730;color:var(--fg);font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .result{display:grid;gap:8px}
  .callout{border-left:4px solid var(--acc);background:#0f1a39;padding:10px 12px;border-radius:8px}
  .ok{border-left-color:var(--ok)} .warn{border-left-color:var(--warn)} .bad{border-left-color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;font-size:13px;padding:8px 10px;background:#0e1730;border:1px solid var(--grid)}
  th{color:#b9c8ef;background:#0c1630}
  tr>td:first-child, tr>th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr>td:last-child, tr>th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#14224a;border:1px solid var(--grid);font-size:12px;margin-left:6px}
  .btn{background:linear-gradient(180deg,#2a74ff,#2156c9);border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .footer{margin:16px 0 40px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="brand">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M3 13c4 0 7-3 7-7 0 0 0 0 0 0 0 4 3 7 7 7 0 0 0 0 0 0-4 0-7 3-7 7 0 0 0 0 0 0 0-4-3-7-7-7Z" fill="#7BDcff"/></svg>
    <div>
      <h1>æ¥“ä¹‹è°·è£œæ°´æ•ˆç‡åŠ©æ‰‹ï¼ˆArtaleç‰ˆï¼‰</h1>
      <div class="subtitle">æ³•å¸«ï¼ˆç«æ¯’ï¼‰ï½œ%è‡ªå‹•è£œå»ºè­°ã€678ã€ä¸‹ä¸€åˆ€å¯æ‰¿å—ã€æœ€çœè£œå“çµ„åˆ</div>
    </div>
  </div>

  <!-- åŸºæœ¬è¼¸å…¥ -->
  <div class="grid">
    <div class="card">
      <h2>è§’è‰²èˆ‡ç’°å¢ƒ</h2>
      <div class="row">
        <div><label>æœ€å¤§ HP</label><input id="maxHP" type="number" min="1" value="1200" /></div>
        <div><label>æœ€å¤§ MP</label><input id="maxMP" type="number" min="1" value="7000" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>è¢«æ’ / å–®æ¬¡å‚·å®³ï¼ˆä¼°ï¼‰</label><input id="hitDmg" type="number" min="1" value="1350" /></div>
        <div>
          <label>è‡ªå‹•è£œæ¨¡å¼</label>
          <select id="autoMode">
            <option value="678" selected>678 ç†è«–</option>
            <option value="700">ç›®æ¨™ 700</option>
            <option value="800">ç›®æ¨™ 800</option>
            <option value="manual">æ‰‹å‹•è¼¸å…¥ %</option>
          </select>
        </div>
      </div>
      <div class="row" id="manualRow" style="margin-top:8px;display:none">
        <div><label>HPï¼… é–€æª»</label><input id="hpPctManual" type="number" min="1" max="99" value="80" /></div>
        <div><label>MPï¼… é–€æª»</label><input id="mpPctManual" type="number" min="1" max="99" value="10" /></div>
      </div>
      <div class="help" style="margin-top:8px">678 æœƒç”¨ âŒŠ678/æœ€å¤§MPâŒ‹% ä½œ MPé–€æª»ï¼›å¯¦éš›ç›®æ¨™å–ã€Œæ­¤é–€æª»ã€èˆ‡ã€Œä¸‹ä¸€åˆ€å¯æ‰¿å—ã€çš„è¼ƒå¤§å€¼ã€‚</div>
    </div>

    <!-- æŠ€èƒ½ -->
    <div class="card">
      <h2>æŠ€èƒ½ç­‰ç´šï¼ˆå¯äº’å‹•ï¼‰</h2>
      <div class="row4">
        <div><label>é­”å¿ƒé˜²ç¦¦ Lv.</label><select id="mgLv"></select></div>
        <div><label>é­”åŠ›ä¹‹ç›¾ Lv.</label><select id="maLv"></select></div>
        <div><label>ç¬é–“ç§»å‹• Lv.</label><select id="teleLv"></select></div>
        <div><label>é­”åŠ›æ¿€ç™¼ Lv.</label><select id="ampLv"></select></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>æ¯’éœ§ Lv.</label><select id="poisonMistLv"></select></div>
        <div><label>è‡´å‘½æ¯’éœ§ Lv.</label><select id="poisonFogLv"></select></div>
      </div>
      <div class="help" style="margin-top:8px">æ­¤å·¥å…·åªè¨ˆå…¥ã€Œè€—é­”/è€—è¡€ã€èˆ‡é­”å¿ƒæ›¿ä»£ç‡ï¼›è¼¸å‡ºåƒ…å½±éŸ¿è£œæ°´è¨ˆç®—ã€‚</div>
    </div>
  </div>

  <!-- åƒ¹æ ¼ä¾†æº -->
  <div class="card" style="margin-top:12px">
    <h2>è£œå“åƒ¹æ ¼ä¾†æº</h2>
    <div class="row">
      <div>
        <label>åƒ¹æ ¼æ¨¡å¼</label>
        <select id="priceMode">
          <option value="min" selected>ç”¨æœ€ä½åƒ¹ï¼ˆç¶“æ¿Ÿå¯¦æƒ ï¼‰</option>
          <option value="loc">æŒ‡å®šåœ°é»åƒ¹æ ¼</option>
        </select>
      </div>
      <div>
        <label>æŒ‡å®šåœ°é»ï¼ˆæ­é…ä¸Šæ–¹ã€ŒæŒ‡å®šåœ°é»åƒ¹æ ¼ã€ä½¿ç”¨ï¼‰</label>
        <select id="priceLoc" disabled></select>
      </div>
    </div>
    <div class="help" style="margin-top:8px">åˆ‡åˆ°ã€ŒæŒ‡å®šåœ°é»ã€æ™‚ï¼Œæ¨è–¦èˆ‡è¡¨æ ¼éƒ½æœƒä»¥è©²åœ°é»åƒ¹è¨ˆç®—ã€‚</div>
  </div>

  <!-- çµæœ -->
  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h2>å»ºè­°è‡ªå‹•è£œé–€æª» & æ¯åˆ€å¯¦éš›æ¶ˆè€—</h2>
      <div class="result" id="summary"></div>
      <div style="margin-top:10px"><button class="btn" id="recalc">é‡æ–°è¨ˆç®—</button></div>
    </div>
    <div class="card">
      <h2>æ¨è–¦è£œå“çµ„åˆï¼ˆäº‹ä»¶æˆæœ¬æœ€çœï¼‰</h2>
      <div id="reco"></div>
    </div>
  </div>

  <!-- è¡¨æ ¼ -->
  <div class="card" style="margin-top:12px">
    <h2>è£œå“è³‡æ–™ï¼ˆArtale ç‰ˆï¼‰ <span class="badge" id="badgePriceMode">æœ€ä½åƒ¹</span></h2>
    <div class="help">CP = è£œé‡ / åƒ¹æ ¼ï¼›åŒå“å¤šåœ°é»æœƒä¾ç›®å‰æ¨¡å¼é¡¯ç¤ºã€‚</div>

    <h3 style="margin:14px 0 6px">HP è—¥æ°´</h3>
    <div id="hpTable"></div>

    <h3 style="margin:14px 0 6px">MP è—¥æ°´</h3>
    <div id="mpTable"></div>

    <h3 style="margin:14px 0 6px">ç¶œåˆï¼ˆHP&MPï¼‰</h3>
    <div id="mixTable"></div>
  </div>

  <div class="footer">Artale-æ•´åˆæœ€çµ‚ç‰ˆã€‚è¨ˆç®—ä»¥ã€Œå–®æ¬¡è§¸ç™¼çš„äº‹ä»¶æˆæœ¬ã€ç‚ºä¸»ï¼Œç¢ºä¿è‡ªå‹•è£œå¾Œä»èƒ½æ‰¿å—ä¸‹ä¸€åˆ€ï¼›è«‹ä¾å¯¦æˆ°å†å¾®èª¿é–€æª»ã€‚</div>
</div>

<script>
/* ================= è³‡æ–™ï¼šæŠ€èƒ½ ================= */
const MAGIC_GUARD = Array.from({length:20}, (_,i)=>{
  const lv=i+1, ratio=[4,8,12,16,20,24,28,32,36,40,44,48,52,56,60,64,68,72,76,80][i];
  const mpCost = lv<=10?6:12;
  const durSec = [30,60,90,120,150,180,210,240,270,300,330,360,390,420,450,480,510,540,570,600][i];
  return {lv, ratio, mpCost, durSec};
});
const MAGIC_ARMOR = Array.from({length:20}, (_,i)=>{
  const lv=i+1, mpCost=lv<=10?8:16, durSec=[20,40,60,80,100,120,140,160,180,200,220,240,260,280,300,320,340,360,380,400][i];
  return {lv, mpCost, durSec, def:2*lv};
});
const TELEPORT = Array.from({length:20}, (_,i)=>({lv:i+1, mp:[60,57,54,51,48,45,42,39,36,33,31,29,27,25,23,21,19,17,15,13][i]}));
const POISON_MIST = Array.from({length:30}, (_,i)=>({lv:i+1, mp:(i+1)<=15?10:20}));
const POISON_FOG  = Array.from({length:30}, (_,i)=>({lv:i+1, mp:21+(i)})); // 1â†’21, 30â†’50
const SPELL_BOOST = Array.from({length:20},(_,i)=>({lv:i+1,hp:[58,56,54,52,50,48,46,44,42,40,39,38,37,36,35,34,33,32,31,30][i],mp:[53,51,49,47,45,43,41,39,37,35,34,33,32,31,30,29,28,27,26,25][i]}));
const AMP_MAGIC   = Array.from({length:30},(_,i)=>({lv:i+1,costPct:[105,110,115,120,125,130,135,140,145,150,160,155,165,160,170,165,175,170,180,175,185,180,190,185,195,190,205,200,195,200][i], dmgPct:[107,109,111,113,114,115,116,117,118,119,121,121,123,123,125,125,127,127,129,129,131,131,133,133,135,135,137,137,137,140][i]}));

/* ================= è³‡æ–™ï¼šè£œå“ï¼ˆArtale å¤šåœ°é»ï¼‰ ================= */
const HP_POTS = [
  {name:"è˜‹æœ", amount:30, prices:{ "é˜²è¡›æœ¬éƒ¨":28, "å…¶é¤˜åœ°åœ–":30 }},
  {name:"ç´…è‰²è—¥æ°´/é›è›‹", amount:50, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":47, "å…¶é¤˜åœ°åœ–":50 }},
  {name:"çƒ¤è‚‰", amount:100, prices:{ "å…¨è—¥æ°´åº—å‡ä¸€åƒ¹":106 }},
  {name:"æ©˜è‰²è—¥æ°´", amount:150, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":152, "å…¶é¤˜åœ°åœ–":160 }},
  {name:"ç‚¸é›", amount:200, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":209, "èèŸ»æ´":220 }},
  {name:"ç™½è‰²è—¥æ°´", amount:300, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":304, "ç…‰é‡‘è¡“å£«çä»»å‹™":310, "å…¶é¤˜åœ°åœ–":320 }},
  {name:"å¤§ç†±ç‹—", amount:300, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":304, "èèŸ»æ´":320 }},
  {name:"æŠ«è–©/æ¼¢å ¡", amount:400, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":427, "èèŸ»æ´":450 }},
  {name:"ç†±ç‹—å ¡", amount:500, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":503, "èèŸ»æ´":530 }},
  {name:"çƒ¤é°»é­š", amount:1000, prices:{ "é˜²è¡›æœ¬éƒ¨":1045, "ç…‰é‡‘è¡“å£«çä»»å‹™":1060, "å¤šåœ°å€é€šç”¨åƒ¹":1100, "æ„›å¡”-ç³–æœæ©Ÿ":1144 }},
  {name:"æ£’å†°æ£’", amount:2000, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":2185, "å¤šåœ°å€é€šç”¨åƒ¹":2300 }},
  {name:"ä¹³é…ª", amount:4000, prices:{ "å†°åŸ/ç«¥è©±æ‘/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":4500, "æ„›å¡”/é˜²è¡›æœ¬éƒ¨/æ™‚é–“é€šé“":4680 }},
  {name:"é¦´é¹¿å¥¶", amount:5000, prices:{ "å†°åŸ/é˜²è¡›æœ¬éƒ¨/ç«¥è©±æ‘/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":5600, "æ„›å¡”-ç³–æœæ©Ÿ/æ™‚é–“é€šé“":5824 }},
];
const MP_POTS = [
  {name:"æŸ³æ©™", amount:50, prices:{ "é˜²è¡›æœ¬éƒ¨":95, "é­”æ£®":97, "å…¶é¤˜åœ°åœ–":100 }},
  {name:"è—è‰²è—¥æ°´", amount:100, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":190, "é­”æ£®":192, "å…¶é¤˜åœ°åœ–":200 }},
  {name:"æª¸æª¬", amount:150, prices:{ "é˜²è¡›æœ¬éƒ¨":294, "é­”æ£®":305, "å…¶é¤˜åœ°åœ–":310 }},
  {name:"æ²™æ‹‰", amount:200, prices:{ "èèŸ»æ´":420 }},
  {name:"æ´»åŠ›è—¥æ°´", amount:300, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":589, "é­”æ£®":604, "å…¶é¤˜åœ°åœ–":620 }},
  {name:"ç¤¦æ³‰æ°´", amount:800, prices:{ "é˜²è¡›æœ¬éƒ¨":1567, "ç…‰é‡‘è¡“å£«çä»»å‹™":1600, "å¤šåœ°å€é€šç”¨åƒ¹":1650, "æ„›å¡”-ç³–æœæ©Ÿ":1716 }},
  {name:"ç´…è±†åˆ¨å†°", amount:2000, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ/é˜²è¡›æœ¬éƒ¨":3800, "å¤šåœ°å€é€šç”¨åƒ¹":4000 }},
  {name:"æ¸…æ™¨ä¹‹éœ²", amount:4000, prices:{ "é˜²è¡›æœ¬éƒ¨":7695, "å†°åŸ/ç«¥è©±æ‘/æ™‚é–“é€šé“/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":8100, "æ„›å¡”-ç³–æœæ©Ÿ":8424 }},
  {name:"é»ƒæ˜ä¹‹éœ²", amount:5000, prices:{ "é˜²è¡›æœ¬éƒ¨":9690, "å†°åŸ/ç«¥è©±æ‘/æ™‚é–“é€šé“/ä¸å¤œåŸ/æ¡ƒèŠ±ä»™å¢ƒ":10200, "æ„›å¡”-ç³–æœæ©Ÿ":10608 }},
];
const MIX_POTS = [
  {name:"å·§å…‹åŠ›(1000/1000)", hp:1000, mp:1000, prices:{ "ä¸€èˆ¬":3000, "ç©å…·åŸ":2850 }},
  {name:"è›‹ç³•(100/100)", hp:100, mp:100, prices:{ "ç©å…·åŸ/ç³–æœæ©Ÿ":304, "èèŸ»æ´":320 }},
  {name:"è¥¿ç“œ(1000/1000)", hp:1000, mp:1000, prices:{ "é˜²è¡›æœ¬éƒ¨":3034, "ç…‰é‡‘è¡“å£«çä»»å‹™":3120, "å¤šåœ°å€é€šç”¨åƒ¹":3200 }},
];

/* ================= UI åˆå§‹åŒ– ================= */
function fillSelect(id, max){ const el=document.getElementById(id); el.innerHTML=""; for(let i=1;i<=max;i++){ const o=document.createElement("option"); o.value=i; o.textContent=i; el.appendChild(o);} }
["mgLv","maLv","teleLv"].forEach((id,idx)=>fillSelect(id, id==="teleLv"?20:20));
fillSelect("ampLv",30); fillSelect("poisonMistLv",30); fillSelect("poisonFogLv",30);

const priceLocSel=document.getElementById("priceLoc");
const ALL_LOCS = Array.from(new Set([
  ...HP_POTS.flatMap(p=>Object.keys(p.prices)),
  ...MP_POTS.flatMap(p=>Object.keys(p.prices)),
  ...MIX_POTS.flatMap(p=>Object.keys(p.prices))
]));
ALL_LOCS.forEach(loc=>{ const opt=document.createElement("option"); opt.value=loc; opt.textContent=loc; priceLocSel.appendChild(opt); });
priceLocSel.value=ALL_LOCS[0];

const priceModeSel=document.getElementById("priceMode");
priceModeSel.addEventListener("change", ()=>{
  const isLoc=priceModeSel.value==="loc";
  priceLocSel.disabled=!isLoc;
  document.getElementById("badgePriceMode").textContent=isLoc?`æŒ‡å®šåœ°é»ï¼š${priceLocSel.value}`:"æœ€ä½åƒ¹";
  renderTables(); recalcAll();
});
priceLocSel.addEventListener("change", ()=>{ document.getElementById("badgePriceMode").textContent=`æŒ‡å®šåœ°é»ï¼š${priceLocSel.value}`; renderTables(); recalcAll(); });

const autoModeSel=document.getElementById("autoMode");
autoModeSel.addEventListener("change", ()=>{ document.getElementById("manualRow").style.display = autoModeSel.value==="manual" ? "" : "none"; recalcAll(); });

/* ================= å·¥å…· ================= */
function pickPrice(prices){ if(priceModeSel.value==="min"){ return Math.min(...Object.values(prices)); } const loc=priceLocSel.value; return (loc in prices)? prices[loc] : Math.min(...Object.values(prices)); }
function cp(amount, price){ return amount/price; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function floor(n){ return Math.floor(n); }

/* ================= è¨ˆç®—æ ¸å¿ƒ ================= */
function calcHitLoss(hit, mgLv){
  const mg=MAGIC_GUARD[mgLv-1]??{ratio:0};
  const r=mg.ratio/100;
  return { hpLoss: hit*(1-r), mpLoss: hit*r, mgRatio: mg.ratio };
}

function suggestThresholds(maxHP,maxMP,hit, mgLv, mode, manualHPpct, manualMPpct, teleLv, fogLv){
  const loss = calcHitLoss(hit, mgLv);
  let mpPct;
  if(mode==="678") mpPct=floor((678/maxMP)*100);
  else if(mode==="700") mpPct=floor((700/maxMP)*100);
  else if(mode==="800") mpPct=floor((800/maxMP)*100);
  else mpPct=clamp(floor(manualMPpct),1,99);

  // åˆæ­¥ç›®æ¨™ï¼ˆï¼…â†’çµ•å°å€¼ï¼‰
  let mpTarget = Math.ceil(mpPct/100 * maxMP);
  let hpPct = (mode==="manual")? clamp(floor(manualHPpct),1,99)
                                : clamp(floor(((maxHP - loss.hpLoss)/maxHP)*100)+1,1,99);
  let hpTarget = Math.ceil(hpPct/100 * maxHP);

  // æŠ€èƒ½ç·©è¡ï¼ˆé€£çºŒæ“ä½œå®‰å…¨é‡ï¼‰
  const teleMP = TELEPORT[teleLv-1].mp;
  const fogMP  = POISON_FOG[fogLv-1].mp;
  const buffer = 2*teleMP + 2*fogMP;

  // **é—œéµä¿®æ­£**ï¼šè‡ªå‹•è£œå¾Œå¿…é ˆèƒ½ã€Œå†æ‰›ä¸‹ä¸€åˆ€ã€
  // MP è‡³å°‘è¦èƒ½å¸æ”¶ä¸‹ä¸€åˆ€çš„é­”å¿ƒä»½é¡ + ç·©è¡ï¼›HP è‡³å°‘èƒ½æ‰›ä¸‹ä¸€åˆ€ç•™ä¸‹çš„ HP å‚·å®³
  mpTarget = Math.max(mpTarget, Math.ceil(loss.mpLoss + buffer));
  hpTarget = Math.max(hpTarget, Math.ceil(loss.hpLoss));

  // è½‰å›é¡¯ç¤ºç™¾åˆ†æ¯”ï¼ˆåƒ…ä½œé¡¯ç¤ºï¼‰
  hpPct = clamp(floor(hpTarget/maxHP*100),1,99);
  mpPct = clamp(floor(mpTarget/maxMP*100),1,99);

  const note = `è‡ªå‹•è£œå¾Œè‡³å°‘å¯å†æ‰›ä¸‹ä¸€åˆ€ï¼ˆHPâ‰¥${Math.round(loss.hpLoss)}ã€MPâ‰¥${Math.round(loss.mpLoss)}+ç·©è¡${buffer}ï¼‰ã€‚`;
  return {hpPct, mpPct, hpTarget, mpTarget, loss, note};
}

// äº‹ä»¶æˆæœ¬æœ€çœï¼šå…è¨±ä¸€æ¬¡è§¸ç™¼é€£åƒå¤šç“¶ï¼ŒæŒ‘ç¸½æˆæœ¬æœ€ä½ä¸”æµªè²»æœ€å°‘çš„
function bestPotEvent(need, pots){
  let best=null;
  for(const p of pots){
    const price=pickPrice(p.prices);
    const amount=p.amount;
    const uses = Math.ceil(need/amount) || 0;
    const eventCost = uses * price;
    const over = Math.max(uses*amount - need, 0);
    const ratio = cp(amount, price);
    const cand={name:p.name, amount, price, uses, eventCost, over, ratio};
    if(!best || cand.eventCost<best.eventCost || (cand.eventCost===best.eventCost && cand.over<best.over)){
      best=cand;
    }
  }
  return best;
}

/* ================= è¡¨æ ¼æ¸²æŸ“ ================= */
function renderTable(containerId, headers, rows){
  const el=document.getElementById(containerId);
  const table=document.createElement("table");
  const thead=document.createElement("thead");
  const trh=document.createElement("tr");
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{ const tr=document.createElement("tr"); r.forEach(c=>{ const td=document.createElement("td"); td.innerHTML=c; tr.appendChild(td); }); tbody.appendChild(tr); });
  table.appendChild(tbody); el.innerHTML=""; el.appendChild(table);
}

function renderTables(){
  const isLoc = priceModeSel.value==="loc";
  const hpRows = HP_POTS.map(p=>{ const price=pickPrice(p.prices); const locUsed=Object.keys(p.prices).find(k=>p.prices[k]===price)||"-"; return [p.name, p.amount, price, (p.amount/price).toFixed(3), isLoc? priceLocSel.value : `æœ€ä½åƒ¹æ–¼ã€Œ${locUsed}ã€`]; });
  renderTable("hpTable", ["è—¥æ°´å","è£œé‡(HP)","åƒ¹æ ¼","è½‰æ›ç‡","è³¼è²·åœ°"], hpRows);

  const mpRows = MP_POTS.map(p=>{ const price=pickPrice(p.prices); const locUsed=Object.keys(p.prices).find(k=>p.prices[k]===price)||"-"; return [p.name, p.amount, price, (p.amount/price).toFixed(3), isLoc? priceLocSel.value : `æœ€ä½åƒ¹æ–¼ã€Œ${locUsed}ã€`]; });
  renderTable("mpTable", ["è—¥æ°´å","è£œé‡(MP)","åƒ¹æ ¼","è½‰æ›ç‡","è³¼è²·åœ°"], mpRows);

  const mixRows = MIX_POTS.map(p=>{ const price=pickPrice(p.prices); const locUsed=Object.keys(p.prices).find(k=>p.prices[k]===price)||"-"; const ratio=((p.hp+p.mp)/price).toFixed(3); return [p.name, `${p.hp}&${p.mp}`, price, ratio, isLoc? priceLocSel.value : `æœ€ä½åƒ¹æ–¼ã€Œ${locUsed}ã€`]; });
  renderTable("mixTable", ["è—¥æ°´å","è£œé‡(HP&MP)","åƒ¹æ ¼","æ¯”å€¼","è³¼è²·åœ°"], mixRows);
}

/* ================= é‡ç®—ï¼ˆæ ¸å¿ƒè¼¸å‡ºï¼‰ ================= */
function recalcAll(){
  const maxHP=+document.getElementById("maxHP").value||1;
  const maxMP=+document.getElementById("maxMP").value||1;
  const hitDmg=+document.getElementById("hitDmg").value||0;

  const mgLv=+document.getElementById("mgLv").value||1;
  const maLv=+document.getElementById("maLv").value||1;
  const teleLv=+document.getElementById("teleLv").value||1;
  const ampLv=+document.getElementById("ampLv").value||1;
  const mistLv=+document.getElementById("poisonMistLv").value||1;
  const fogLv=+document.getElementById("poisonFogLv").value||1;

  const manualHPpct=+document.getElementById("hpPctManual").value||80;
  const manualMPpct=+document.getElementById("mpPctManual").value||10;
  const mode=document.getElementById("autoMode").value;

  const {hpPct, mpPct, hpTarget, mpTarget, loss, note} = suggestThresholds(maxHP,maxMP,hitDmg,mgLv,mode, manualHPpct, manualMPpct, teleLv, fogLv);

  // å—åˆ°é€™åˆ€å¾Œçš„å³æ™‚ HP/MP
  const hpAfter = maxHP - loss.hpLoss;
  const mpAfter = maxMP - loss.mpLoss;

  // çœŸæ­£ç¼ºå£ï¼ˆè¦è£œåˆ°ã€Œç›®æ¨™ã€ï¼‰
  // MP/HP è£œæ­£ï¼šé­”åŠ›æ¿€ç™¼åªå½±éŸ¿æŠ€èƒ½è€—é­”ï¼Œä¸å½±éŸ¿è£œå“ï¼›æ­¤è™•ä¸åŠ å€
  let needHP = Math.max(hpTarget - hpAfter, 0);
  let needMP = Math.max(mpTarget - mpAfter, 0);

  // æ‰¾ã€Œäº‹ä»¶æˆæœ¬ã€æœ€çœçš„è£œæ³•ï¼ˆå…è¨±ä¸€æ¬¡è§¸ç™¼é€£åƒå¤šç“¶ï¼‰
  const hpPick = bestPotEvent(needHP, HP_POTS);
  const mpPick = bestPotEvent(needMP, MP_POTS);

  // æŠ€èƒ½ç¶­è­·ï¼ˆæ¯åˆ†é˜ï¼‰
  const mg=MAGIC_GUARD[mgLv-1], ma=MAGIC_ARMOR[maLv-1];
  const mgPerMin = mg ? mg.mpCost * (60/(mg.durSec||60)) : 0;
  const maPerMin = ma ? ma.mpCost * (60/(ma.durSec||60)) : 0;

  // æ¥µé€Ÿè© å”±/ç¬ç§»/æ¯’éœ§è€—é­”ï¼ˆå«é­”åŠ›æ¿€ç™¼å€ç‡ï¼‰
  const amp = AMP_MAGIC[ampLv-1]||{costPct:100};
  const ampRate=(amp.costPct||100)/100;
  const teleOnce = TELEPORT[teleLv-1].mp * ampRate;
  const mistOnce = POISON_MIST[mistLv-1].mp * ampRate;
  const fogOnce  = POISON_FOG[fogLv-1].mp  * ampRate;

  const sum=document.getElementById("summary");
  sum.innerHTML = `
    <div class="callout ok">
      <div>ğŸ›¡ï¸ é­”å¿ƒæ›¿ä»£ç‡ï¼š<b>${mg?.ratio||0}%</b>ï¼ˆLv.${mgLv}ï¼Œç¶­è­·ï¼š${mg?.mpCost||0} MP / ${mg?.durSec||0}sï¼‰</div>
      <div>ğŸ§· é­”åŠ›ä¹‹ç›¾ï¼šLv.${maLv}ï¼ˆç¶­è­·ï¼š${ma?.mpCost||0} MP / ${ma?.durSec||0}sï¼‰</div>
    </div>
    <div class="callout">
      <div>ğŸ’¥ æœ¬åˆ€å¯¦æ â‰ˆ <b>HP ${Math.round(loss.hpLoss)}</b>ã€<b>MP ${Math.round(loss.mpLoss)}</b></div>
      <div class="muted">ï¼ˆå‚·å®³ ${hitDmg}ï¼›é­”å¿ƒåˆ†æµ ${mg?.ratio||0}% â†’ MPï¼‰</div>
    </div>
    <div class="callout">
      <div>ğŸ§® å»ºè­°è‡ªå‹•è£œé–€æª» â†’ HP <b>${hpPct}%</b>ï¼ˆâ‰¥æœ¬åˆ€HPæï¼‰ï¼ŒMP <b>${mpPct}%</b>ï¼ˆâ‰¥æœ¬åˆ€MPæï¼‹ç·©è¡ï¼‰</div>
      <div class="muted">${note}</div>
    </div>
    <div class="callout">
      <div>ğŸ§± æŠ€èƒ½ç¶­è­·ï¼ˆä¼°æ¯åˆ†é˜ï¼‰ï¼šé­”å¿ƒ ${mgPerMin.toFixed(1)} MPã€é­”ç›¾ ${maPerMin.toFixed(1)} MP</div>
      <div class="muted">ç¬ç§» ${Math.round(teleOnce)} MPï¼æ¬¡ã€æ¯’éœ§ ${Math.round(mistOnce)} MPï¼æ¬¡ã€è‡´å‘½æ¯’éœ§ ${Math.round(fogOnce)} MPï¼æ¬¡ï¼ˆå«é­”åŠ›æ¿€ç™¼å€ç‡ï¼‰</div>
    </div>
  `;

  const reco=document.getElementById("reco");
  const hpCp1000 = hpPick ? (1000*hpPick.price/hpPick.amount).toFixed(1) : "-";
  const mpCp1000 = mpPick ? (1000*mpPick.price/mpPick.amount).toFixed(1) : "-";
  reco.innerHTML = `
    <div class="callout ok">
      <div>âœ… HPï¼š<b>${hpPick.name}</b>ã€€éœ€è¦è£œå› <b>${Math.round(needHP)}</b> â†’ <b>æ¯æ¬¡è§¸ç™¼åƒ ${hpPick.uses} ç“¶</b>ï¼ŒèŠ±è²» â‰ˆ <b>$${hpPick.eventCost}</b>
      <span class="badge">æ¯1000é‡ â‰ˆ $${hpCp1000}</span></div>
      <div class="muted">è‹¥æƒ³æ¸›å°‘é€£åƒæ¬¡æ•¸ï¼Œæ”¹ç”¨æ›´å¤§ç“¶ï¼ˆå¦‚ï¼šçƒ¤é°»é­š/æ£’å†°æ£’/ä¹³é…ªï¼‰ã€‚</div>
    </div>
    <div class="callout ok">
      <div>âœ… MPï¼š<b>${mpPick.name}</b>ã€€éœ€è¦è£œå› <b>${Math.round(needMP)}</b> â†’ <b>æ¯æ¬¡è§¸ç™¼åƒ ${mpPick.uses} ç“¶</b>ï¼ŒèŠ±è²» â‰ˆ <b>$${mpPick.eventCost}</b>
      <span class="badge">æ¯1000é‡ â‰ˆ $${mpCp1000}</span></div>
      <div class="muted">é­”å¿ƒåƒå‚·ä¸»è¦åœ¨ MPï¼›å¤§ç¼ºå£æƒ…å¢ƒæœƒè‡ªç„¶æ¨è–¦ç¤¦æ³‰æ°´/ç´…è±†åˆ¨å†°/æ¸…æ™¨ä¹‹éœ²ï¼Œè€ŒéæŸ³æ©™ã€‚</div>
    </div>
  `;
}

/* ================= è¡¨æ ¼èˆ‡äº‹ä»¶ç¶å®š ================= */
function renderAll(){ renderTables(); recalcAll(); }
document.getElementById("recalc").addEventListener("click", recalcAll);
["mgLv","maLv","teleLv","ampLv","poisonMistLv","poisonFogLv","maxHP","maxMP","hitDmg","hpPctManual","mpPctManual"].forEach(id=>{
  document.getElementById(id).addEventListener("input", recalcAll);
  document.getElementById(id).addEventListener("change", recalcAll);
});
renderAll();
</script>
</body>
</html>
